<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNStock Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2F80ED',
                        secondary: '#4154F1',
                        accent: '#6C63FF',
                        light: '#F5F6FA',
                        medium: '#C4C4C4',
                        dark: '#333333'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        }
    </script>
    
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .sidebar-item {
            transition: all 0.2s ease-in-out;
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #2F80ED 0%, #4154F1 100%);
            color: white;
            border-left: 4px solid #fff;
        }
        
        .sidebar-item:hover:not(.active) {
            background-color: #F5F6FA;
            transform: translateX(4px);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="bg-light font-sans">
    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="fixed top-4 left-4 z-50 md:hidden bg-primary text-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 bg-white shadow-xl z-40 md:translate-x-0">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-dark">VNStock</h1>
                    <p class="text-sm text-gray-500">Analyzer</p>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="p-4">
            <ul class="space-y-2">
                <li>
                    <a href="#" class="sidebar-item active flex items-center space-x-3 p-3 rounded-lg font-medium" data-page="news">
                        <i class="fas fa-newspaper text-lg"></i>
                        <span>News</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg font-medium" data-page="analyze">
                        <i class="fas fa-analytics text-lg"></i>
                        <span>Analyze</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg font-medium" data-page="company-update">
                        <i class="fas fa-building text-lg"></i>
                        <span>Company Update</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg font-medium" data-page="documents">
                        <i class="fas fa-book text-lg"></i>
                        <span>Documents</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <!-- User Info -->
        <div class="absolute bottom-0 w-full p-4 border-t border-gray-100">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-dark">Stock Trader</p>
                    <p class="text-xs text-gray-500">Premium User</p>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Overlay for mobile -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    
    <!-- Main Content -->
    <main class="md:ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-100 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 id="pageTitle" class="text-2xl font-bold text-dark">Market News</h2>
                    <p id="pageSubtitle" class="text-gray-500 mt-1">Stay updated with the latest Vietnamese stock market insights</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="p-2 text-gray-400 hover:text-primary transition-colors">
                        <i class="fas fa-bell text-lg"></i>
                    </button>
                    <button class="p-2 text-gray-400 hover:text-primary transition-colors">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="p-6">
            <!-- News Page -->
            <div id="newsPage" class="page-content">
                <!-- VNINDEX Chart Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-dark flex items-center">
                                <i class="fas fa-chart-area text-primary mr-3"></i>
                                VN-Index Performance
                            </h3>
                            <p class="text-gray-500 mt-1">Vietnam's benchmark stock index</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="vnindex-period-btn px-4 py-2 text-sm font-medium rounded-lg bg-primary text-white" data-period="1M">1M</button>
                            <button class="vnindex-period-btn px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-period="3M">3M</button>
                            <button class="vnindex-period-btn px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-period="6M">6M</button>
                            <button class="vnindex-period-btn px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-period="1Y">1Y</button>
                        </div>
                    </div>
                    
                    <!-- Price Display -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Current Value</p>
                                <p class="text-2xl font-bold text-dark" id="vnindexPrice">-</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Change</p>
                                <div id="vnindexChange" class="text-lg font-semibold">
                                    <span class="text-gray-400">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative h-80">
                        <canvas id="vnindexChart" class="w-full h-full"></canvas>
                        <div id="vnindexLoading" class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-2xl text-primary mb-2"></i>
                                <p class="text-gray-500">Loading VN-Index data...</p>
                            </div>
                        </div>
                        <div id="vnindexError" class="absolute inset-0 flex items-center justify-center hidden">
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-2"></i>
                                <p class="text-gray-500">Unable to load VN-Index data</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Stock Activity -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-dark flex items-center">
                                <i class="fas fa-fire text-red-500 mr-3"></i>
                                Trending Stocks
                            </h3>
                            <p class="text-gray-500 mt-1">Most mentioned stocks in recent news</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label for="dashboardDays" class="text-sm font-medium text-gray-700">Period:</label>
                            <select id="dashboardDays" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="1">1 day</option>
                                <option value="3" selected>3 days</option>
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                            </select>
                            <button id="refreshStocksBtn" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="bg-light rounded-lg p-4 mb-6">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-search mr-1 text-primary"></i>Search:
                                </label>
                                <input 
                                    id="stockSearch" 
                                    type="text" 
                                    placeholder="Enter stock symbol..." 
                                    class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent w-40"
                                >
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-smile mr-1 text-primary"></i>Sentiment:
                                </label>
                                <select id="sentimentFilter" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">All</option>
                                    <option value="positive">Positive</option>
                                    <option value="neutral">Neutral</option>
                                    <option value="negative">Negative</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-star mr-1 text-yellow-500"></i>VN30:
                                </label>
                                <select id="vn30Filter" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">All</option>
                                    <option value="true">VN30 Only</option>
                                    <option value="false">Non-VN30</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-sort mr-1 text-primary"></i>Sort by:
                                </label>
                                <select id="sortBy" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="posts_count">Post Count</option>
                                    <option value="symbol">Symbol</option>
                                    <option value="last_updated">Date</option>
                                    <option value="sentiment">Sentiment</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <select id="sortOrder" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="desc">Descending</option>
                                    <option value="asc">Ascending</option>
                                </select>
                            </div>
                            
                            <button id="clearFilters" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                <i class="fas fa-times mr-1"></i>Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stocks Content -->
                    <div id="stocksContent">
                        <div id="stocksLoading" class="text-center py-12">
                            <i class="fas fa-spinner fa-spin text-3xl text-primary mb-4"></i>
                            <p class="text-gray-500 text-lg">Loading trending stocks...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analyze Page -->
            <div id="analyzePage" class="page-content hidden">
                <!-- Data Sources Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-dark flex items-center">
                                <i class="fas fa-globe text-primary mr-3"></i>
                                Data Sources
                            </h3>
                            <p class="text-gray-500 mt-1">Configure news sources for stock analysis</p>
                        </div>
                        <button id="addNewPageBtn" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors font-medium">
                            <i class="fas fa-plus mr-2"></i>Add New Source
                        </button>
                    </div>

                    <!-- Sources List -->
                    <div id="sourcesList" class="space-y-4 mb-6">
                        <div id="emptyState" class="text-center py-12">
                            <i class="fas fa-plus-circle text-4xl text-gray-300 mb-4"></i>   
                            <p class="text-gray-500 text-lg">No sources configured yet</p>
                            <p class="text-gray-400 text-sm">Click "Add New Source" to get started</p>
                        </div>
                    </div>

                    <!-- New Source Form -->
                    <div id="newSourceForm" class="hidden border-t border-gray-100 pt-6">
                        <h4 class="text-lg font-semibold text-dark mb-4">
                            <i class="fas fa-plus-circle mr-2 text-primary"></i>Configure New Source
                        </h4>
                        <form id="sourceForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Source Name</label>
                                    <input type="text" name="sourceName"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="e.g., ACBS Research" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Source Type</label>
                                    <select name="sourceType"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option>Company</option>
                                        <option>Industry</option>
                                        <option>Macro Economy</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-dark mb-2">URL</label>
                                <input type="text" name="url"
                                    class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="https://example.com/news" required />
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">XPath for Posts</label>
                                    <input type="text" name="xpath"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="//a[@class='post-link']" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Pagination Rule</label>
                                    <input type="text" name="paginationRule"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="/page/{}" />
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Content XPath</label>
                                    <input type="text" name="contentXpath"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="//div[@class='content']" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Date XPath</label>
                                    <input type="text" name="contentDateXpath"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="//span[@class='date']" />
                                </div>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-100">
                                <button type="button" id="cancelBtn" class="px-6 py-3 border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                    Cancel
                                </button>
                                <button type="submit" class="px-6 py-3 bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors font-medium">
                                    Save Source
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Analysis Controls -->
                    <div id="crawlSection" class="hidden border-t border-gray-100 pt-6">
                        <div class="bg-gradient-to-r from-primary to-secondary p-6 rounded-xl text-white">
                            <div class="text-center">
                                <h4 class="text-xl font-bold mb-2">Ready to Analyze</h4>
                                <p class="text-blue-100 mb-6">Start crawling and analyzing your configured sources</p>
                                
                                <div class="flex items-center justify-center space-x-6 mb-6">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-calendar-alt text-xl"></i>
                                        <label for="crawlDays" class="font-medium">Analyze posts from last:</label>
                                    </div>
                                    <select id="crawlDays" class="bg-white text-dark border-0 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white">
                                        <option value="1">1 day</option>
                                        <option value="3" selected>3 days</option>
                                        <option value="7">7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                                
                                <button id="crawlAllBtn" class="bg-white text-primary hover:bg-gray-100 px-8 py-4 rounded-lg transition-colors text-lg font-semibold shadow-lg">
                                    <span id="crawlText">
                                        <i class="fas fa-rocket mr-3"></i>Start Analysis
                                    </span>
                                    <i id="crawlLoadingIcon" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsContainer" class="hidden space-y-6">
                    <!-- Metadata Section -->
                    <div id="metadataSection" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-xl font-bold text-dark mb-4">
                            <i class="fas fa-info-circle mr-2 text-primary"></i>Analysis Summary
                        </h3>
                        <div id="metadataContent" class="text-gray-700"></div>
                    </div>

                    <!-- Stock Analysis Section -->
                    <div id="stockAnalysisSection">
                        <h3 class="text-2xl font-bold text-dark mb-6 text-center">
                            <i class="fas fa-chart-line mr-3 text-primary"></i>Stock Analysis Results
                        </h3>
                        <div id="stockAnalysisContent" class="space-y-6"></div>
                    </div>

                    <!-- Individual Posts Section -->
                    <div id="postsSection" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-xl font-bold text-dark mb-4">
                            <i class="fas fa-newspaper mr-2 text-primary"></i>Analyzed Posts
                        </h3>
                        <div id="postsContent" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            
            <!-- Company Update Page -->
            <div id="companyUpdatePage" class="page-content hidden">
                <!-- Manual Company Info Update Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-building text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-dark">Manual Company Info Update</h3>
                            <p class="text-gray-500">Update stock records with ICB codes and company information from VNStock</p>
                        </div>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg">
                        <p class="text-gray-700 leading-relaxed">
                            This tool updates stock records with ICB codes and company information from VNStock. It fetches comprehensive data including industry classifications, company names, and ICB codes for all Vietnamese stocks, enabling better industry analysis and contextual stock insights.
                        </p>
                    </div>
                    
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 text-lg mt-0.5"></i>
                            <div>
                                <p class="font-semibold text-blue-800 mb-1">Safe Update Process</p>
                                <p class="text-blue-700 text-sm">This process updates all stock records with the latest company information from VNStock, including ICB industry codes that enable industry-level analysis. Safe to run multiple times - existing data will be preserved and enhanced.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button id="updateCompanyInfoBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <i id="updateCompanyInfoIcon" class="fas fa-sync-alt mr-3"></i>
                        <span id="updateCompanyInfoText">Update Company Info</span>
                    </button>
                    
                    <!-- Progress Section -->
                    <div id="companyInfoProgressSection" class="hidden mt-8 p-6 bg-gray-50 rounded-lg">
                        <div class="text-center mb-4">
                            <div id="companyInfoProgressText" class="text-lg font-medium text-gray-800 mb-2">Initializing...</div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="companyInfoProgressBar" class="bg-gradient-to-r from-green-500 to-emerald-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div id="companyInfoProgressDetails" class="text-sm text-gray-600"></div>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="companyInfoResultsSection" class="hidden mt-8">
                        <h4 class="text-xl font-bold text-dark mb-4">Company Info Update Results</h4>
                        <div id="companyInfoStatsSection" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                        <div id="companyInfoResultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>
                
                <!-- Manual Company Events Update Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center">
                            <i class="fas fa-calendar-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-dark">Manual Company Events Update</h3>
                            <p class="text-gray-500">Update stock events data with fresh information from vnstock</p>
                        </div>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
                        <p class="text-gray-700 leading-relaxed">
                            This tool will delete all current stock events data and fetch fresh event information from vnstock for all stocks mentioned in the last 30 days. Company events include dividends, stock splits, shareholder meetings, and other corporate actions.
                        </p>
                    </div>
                    
                    <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-amber-600 text-lg mt-0.5"></i>
                            <div>
                                <p class="font-semibold text-amber-800 mb-1">Important Warning</p>
                                <p class="text-amber-700 text-sm">This action will permanently delete all existing stock events data and replace it with fresh data from vnstock. This process may take several minutes depending on the number of stocks to update.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button id="updateCompanyEventsBtn" class="bg-gradient-to-r from-primary to-secondary hover:from-blue-600 hover:to-indigo-600 text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <i id="updateEventsIcon" class="fas fa-sync-alt mr-3"></i>
                        <span id="updateEventsText">Update Company Events</span>
                    </button>
                    
                    <!-- Progress Section -->
                    <div id="eventsProgressSection" class="hidden mt-8 p-6 bg-gray-50 rounded-lg">
                        <div class="text-center mb-4">
                            <div id="eventsProgressText" class="text-lg font-medium text-gray-800 mb-2">Initializing...</div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="eventsProgressBar" class="bg-gradient-to-r from-primary to-secondary h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div id="eventsProgressDetails" class="text-sm text-gray-600"></div>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="eventsResultsSection" class="hidden mt-8">
                        <h4 class="text-xl font-bold text-dark mb-4">Update Results</h4>
                        <div id="eventsStatsSection" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                        <div id="eventsResultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>
                
                <!-- Manual Company Dividends Update Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mt-6">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-coins text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-dark">Manual Company Dividends Update</h3>
                            <p class="text-gray-500">Update stock dividends data with fresh information from vnstock</p>
                        </div>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg">
                        <p class="text-gray-700 leading-relaxed">
                            This tool will delete all current stock dividends data and fetch fresh dividend information from vnstock for all stocks mentioned in the last 30 days. Dividend data includes cash dividend percentages, exercise dates, and issue methods.
                        </p>
                    </div>
                    
                    <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-amber-600 text-lg mt-0.5"></i>
                            <div>
                                <p class="font-semibold text-amber-800 mb-1">Important Warning</p>
                                <p class="text-amber-700 text-sm">This action will permanently delete all existing stock dividends data and replace it with fresh data from vnstock. This process may take several minutes depending on the number of stocks to update.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button id="updateCompanyDividendsBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <i id="updateDividendsIcon" class="fas fa-sync-alt mr-3"></i>
                        <span id="updateDividendsText">Update Company Dividends</span>
                    </button>
                    
                    <!-- Progress Section -->
                    <div id="dividendsProgressSection" class="hidden mt-8 p-6 bg-gray-50 rounded-lg">
                        <div class="text-center mb-4">
                            <div id="dividendsProgressText" class="text-lg font-medium text-gray-800 mb-2">Initializing...</div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="dividendsProgressBar" class="bg-gradient-to-r from-green-500 to-emerald-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div id="dividendsProgressDetails" class="text-sm text-gray-600"></div>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="dividendsResultsSection" class="hidden mt-8">
                        <h4 class="text-xl font-bold text-dark mb-4">Update Results</h4>
                        <div id="dividendsStatsSection" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                        <div id="dividendsResultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <!-- Manual Stock Prices Update Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chart-line text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-dark">Manual Stock Prices Update</h3>
                            <p class="text-gray-500">Update stock prices for stocks mentioned in the last 7 days (only if missing today's data)</p>
                        </div>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg">
                        <p class="text-gray-700 leading-relaxed">
                            This tool will check all stocks mentioned in the last 7 days and update their prices only if they don't have today's price data. This is useful when VNStock quota was exceeded during regular analysis, ensuring your price data stays current.
                        </p>
                    </div>
                    
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 text-lg mt-0.5"></i>
                            <div>
                                <p class="font-semibold text-blue-800 mb-1">Smart Update</p>
                                <p class="text-blue-700 text-sm">The system will automatically skip stocks that already have today's price data, saving VNStock API calls and avoiding unnecessary updates.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button id="updateStockPricesBtn" class="bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white px-8 py-4 rounded-lg transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        <i id="updatePricesIcon" class="fas fa-sync-alt mr-3"></i>
                        <span id="updatePricesText">Update Stock Prices</span>
                    </button>
                    
                    <!-- Progress Section -->
                    <div id="pricesProgressSection" class="hidden mt-8 p-6 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-bold text-dark">Progress</h4>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                            <div id="pricesProgressBar" class="bg-gradient-to-r from-purple-500 to-pink-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="pricesProgressText" class="text-gray-700 font-medium mb-2">Initializing...</p>
                        <p id="pricesProgressDetails" class="text-gray-600 text-sm"></p>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="pricesResultsSection" class="hidden mt-8">
                        <h4 class="text-xl font-bold text-dark mb-4">Update Results</h4>
                        <div id="pricesStatsSection" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                        <div id="pricesResultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>
            </div>

            <!-- Documents Page -->
            <div id="documentsPage" class="page-content hidden">
                <!-- Header Section -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-sm border border-gray-100 p-8 mb-8 text-white">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-16 h-16 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-book text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-3xl font-bold">VNStock Analyzer Documentation</h3>
                            <p class="text-indigo-100 mt-2">Comprehensive guide to understanding and using all features</p>
                        </div>
                    </div>
                </div>

                <!-- Table of Contents -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                    <h4 class="text-xl font-bold text-dark mb-4 flex items-center">
                        <i class="fas fa-list-ul text-indigo-500 mr-3"></i>
                        Table of Contents
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <a href="#overview" class="block p-3 rounded-lg hover:bg-gray-50 border border-gray-200 transition-colors">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                System Overview
                            </a>
                            <a href="#news-feature" class="block p-3 rounded-lg hover:bg-gray-50 border border-gray-200 transition-colors">
                                <i class="fas fa-newspaper text-green-500 mr-2"></i>
                                News Dashboard
                            </a>
                            <a href="#analysis-feature" class="block p-3 rounded-lg hover:bg-gray-50 border border-gray-200 transition-colors">
                                <i class="fas fa-analytics text-purple-500 mr-2"></i>
                                Multi-Source Analysis
                            </a>
                        </div>
                        <div class="space-y-2">
                            <a href="#company-update" class="block p-3 rounded-lg hover:bg-gray-50 border border-gray-200 transition-colors">
                                <i class="fas fa-building text-orange-500 mr-2"></i>
                                Company Data Management
                            </a>
                            <a href="#workflow" class="block p-3 rounded-lg hover:bg-gray-50 border border-gray-200 transition-colors">
                                <i class="fas fa-project-diagram text-red-500 mr-2"></i>
                                System Workflow
                            </a>
                            <a href="#technical" class="block p-3 rounded-lg hover:bg-gray-50 border border-gray-200 transition-colors">
                                <i class="fas fa-cogs text-gray-500 mr-2"></i>
                                Technical Details
                            </a>
                        </div>
                    </div>
                </div>

                <!-- System Overview -->
                <div id="overview" class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
                    <h4 class="text-2xl font-bold text-dark mb-6 flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                        System Overview
                    </h4>
                    
                    <div class="prose max-w-none">
                        <div class="mb-6">
                            <h5 class="text-lg font-semibold text-dark mb-3">What is VNStock Analyzer?</h5>
                            <p class="text-gray-700 leading-relaxed mb-4">
                                VNStock Analyzer is a sophisticated Vietnamese stock market analysis system that combines web scraping, 
                                artificial intelligence, and comprehensive data management to provide intelligent stock market insights. 
                                The system crawls financial news from multiple sources and uses Google's Gemini AI to extract stock 
                                mentions, sentiment analysis, and contextual intelligence.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <h5 class="text-lg font-semibold text-dark mb-3">Key Capabilities</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <i class="fas fa-robot text-blue-600 text-xl mb-2"></i>
                                    <h6 class="font-semibold text-blue-800">AI-Powered Analysis</h6>
                                    <p class="text-blue-700 text-sm">Uses Gemini 2.5-Pro for Vietnamese stock sentiment analysis</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <i class="fas fa-globe text-green-600 text-xl mb-2"></i>
                                    <h6 class="font-semibold text-green-800">Multi-Source Crawling</h6>
                                    <p class="text-green-700 text-sm">Intelligent web scraping with anti-detection measures</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                    <i class="fas fa-chart-area text-purple-600 text-xl mb-2"></i>
                                    <h6 class="font-semibold text-purple-800">Real-time Market Data</h6>
                                    <p class="text-purple-700 text-sm">Live VN-Index and stock price integration via VNStock</p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                    <i class="fas fa-database text-orange-600 text-xl mb-2"></i>
                                    <h6 class="font-semibold text-orange-800">Smart Database</h6>
                                    <p class="text-orange-700 text-sm">Supabase-powered with intelligent deduplication</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h5 class="text-lg font-semibold text-dark mb-3">Target Users</h5>
                            <ul class="text-gray-700 space-y-2">
                                <li class="flex items-start">
                                    <i class="fas fa-chart-line text-green-500 mr-3 mt-1"></i>
                                    <span><strong>Stock Traders:</strong> Get comprehensive sentiment analysis and market insights</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-university text-blue-500 mr-3 mt-1"></i>
                                    <span><strong>Financial Analysts:</strong> Access industry-level trends and macro economic context</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-search text-purple-500 mr-3 mt-1"></i>
                                    <span><strong>Market Researchers:</strong> Analyze Vietnamese stock market patterns and news impact</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- News Dashboard Feature -->
                <div id="news-feature" class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
                    <h4 class="text-2xl font-bold text-dark mb-6 flex items-center">
                        <i class="fas fa-newspaper text-green-500 mr-3"></i>
                        News Dashboard
                    </h4>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">What it does</h5>
                        <p class="text-gray-700 leading-relaxed mb-4">
                            The News Dashboard provides real-time Vietnamese stock market insights with live VN-Index performance 
                            charts and comprehensive market analysis. It displays recent stock mentions, sentiment trends, and 
                            market performance in an intuitive, visually appealing interface.
                        </p>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">How it works</h5>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <ol class="text-gray-700 space-y-2 list-decimal list-inside">
                                <li><strong>VN-Index Integration:</strong> Fetches real-time VN-Index data using VNStock API</li>
                                <li><strong>Interactive Charts:</strong> Displays 1M, 3M, 6M, and 1Y performance with Chart.js</li>
                                <li><strong>Stock Analysis Display:</strong> Shows recent stock mentions with sentiment analysis</li>
                                <li><strong>Market Overview:</strong> Provides market statistics and trending stocks</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Why use it</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <i class="fas fa-tachometer-alt text-green-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-green-800">Real-time Insights</h6>
                                <p class="text-green-700 text-sm">Stay updated with latest market movements and VN-Index performance</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <i class="fas fa-eye text-blue-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-blue-800">Visual Analytics</h6>
                                <p class="text-blue-700 text-sm">Interactive charts make market trends easy to understand</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border border-green-200">
                        <h6 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                            Pro Tip
                        </h6>
                        <p class="text-gray-700 text-sm">
                            Use different time periods (1M, 3M, 6M, 1Y) to understand both short-term volatility and long-term trends 
                            for better investment decisions.
                        </p>
                    </div>
                </div>

                <!-- Multi-Source Analysis Feature -->
                <div id="analysis-feature" class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
                    <h4 class="text-2xl font-bold text-dark mb-6 flex items-center">
                        <i class="fas fa-analytics text-purple-500 mr-3"></i>
                        Multi-Source Analysis System
                    </h4>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">What it does</h5>
                        <p class="text-gray-700 leading-relaxed mb-4">
                            The heart of VNStock Analyzer - a sophisticated system that crawls multiple financial news sources, 
                            analyzes content using AI, and provides comprehensive stock analysis with contextual intelligence. 
                            It supports three types of analysis: Company-specific, Industry-level, and Macro-economic.
                        </p>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Source Types</h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <i class="fas fa-building text-blue-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-blue-800">Company Sources</h6>
                                <p class="text-blue-700 text-sm">Analyze individual stock mentions and company-specific news</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <i class="fas fa-industry text-green-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-green-800">Industry Sources</h6>
                                <p class="text-green-700 text-sm">Track industry trends using Vietnamese ICB classification codes</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <i class="fas fa-globe-asia text-purple-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-purple-800">Macro Sources</h6>
                                <p class="text-purple-700 text-sm">Monitor macro-economic indicators and market environment</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">How it works - 10-Step Process</h5>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <div class="space-y-3">
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">1</span>
                                    <div>
                                        <strong>VN30 Update:</strong> Fetches current VN30 stock list and updates database
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">2</span>
                                    <div>
                                        <strong>Smart Crawling:</strong> Checks database for existing posts, only crawls new content
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">3</span>
                                    <div>
                                        <strong>Content Processing:</strong> Extracts clean text using XPath selectors
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">4</span>
                                    <div>
                                        <strong>AI Analysis:</strong> Gemini 2.5-Pro analyzes content for stocks, industries, or macro themes
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">5</span>
                                    <div>
                                        <strong>Database Storage:</strong> Saves posts and analysis results with relationships
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">6</span>
                                    <div>
                                        <strong>Industry Context:</strong> Maps stocks to industries for contextual analysis
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">7</span>
                                    <div>
                                        <strong>Macro Context:</strong> Adds macro-economic environment to analysis
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">8</span>
                                    <div>
                                        <strong>Price Updates:</strong> Fetches latest stock prices via VNStock API
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">9</span>
                                    <div>
                                        <strong>Company Data:</strong> Updates company information and ICB codes
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="bg-indigo-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5">10</span>
                                    <div>
                                        <strong>Final Results:</strong> Combines all analysis into comprehensive stock insights
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Why use it</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <i class="fas fa-brain text-purple-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-purple-800">Contextual Intelligence</h6>
                                <p class="text-purple-700 text-sm">Get stock analysis enhanced with industry trends and macro environment</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <i class="fas fa-save text-green-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-green-800">Smart Efficiency</h6>
                                <p class="text-green-700 text-sm">Avoids re-crawling existing content, saving time and API quotas</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                        <h6 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                            Advanced Tip
                        </h6>
                        <p class="text-gray-700 text-sm">
                            Configure all three source types (Company, Industry, Macro) for the most comprehensive analysis. 
                            The system will automatically correlate industry trends and macro factors with individual stock mentions.
                        </p>
                    </div>
                </div>

                <!-- Company Data Management Feature -->
                <div id="company-update" class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
                    <h4 class="text-2xl font-bold text-dark mb-6 flex items-center">
                        <i class="fas fa-building text-orange-500 mr-3"></i>
                        Company Data Management
                    </h4>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">What it does</h5>
                        <p class="text-gray-700 leading-relaxed mb-4">
                            A comprehensive suite of tools for maintaining up-to-date Vietnamese stock market data. 
                            Includes manual update capabilities for company information, corporate events, dividends, 
                            and selective price updates, ensuring your analysis is based on the most current data available.
                        </p>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Available Tools</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <i class="fas fa-info-circle text-green-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-green-800">Company Info Update</h6>
                                <p class="text-green-700 text-sm">Updates all stocks with ICB industry codes and company details from VNStock</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <i class="fas fa-calendar-alt text-blue-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-blue-800">Corporate Events</h6>
                                <p class="text-blue-700 text-sm">Fresh company events data for stocks mentioned in last 30 days</p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                                <i class="fas fa-coins text-indigo-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-indigo-800">Dividend Updates</h6>
                                <p class="text-indigo-700 text-sm">Latest dividend information and payment schedules</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <i class="fas fa-chart-line text-purple-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-purple-800">Smart Price Updates</h6>
                                <p class="text-purple-700 text-sm">Selective price updates for recently mentioned stocks missing today's data</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">How it works</h5>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="text-gray-700 mb-3"><strong>Smart Update Process:</strong></p>
                            <ol class="text-gray-700 space-y-2 list-decimal list-inside">
                                <li><strong>Data Validation:</strong> Checks current database state before updates</li>
                                <li><strong>VNStock Integration:</strong> Fetches fresh data using Vietnamese stock APIs</li>
                                <li><strong>Selective Updates:</strong> Only updates what's needed (e.g., missing price data)</li>
                                <li><strong>Progress Tracking:</strong> Real-time progress bars with detailed status updates</li>
                                <li><strong>Results Summary:</strong> Comprehensive reports with success/failure statistics</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Why use it</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                <i class="fas fa-shield-alt text-orange-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-orange-800">API Quota Management</h6>
                                <p class="text-orange-700 text-sm">Recover from VNStock quota limits with manual selective updates</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <i class="fas fa-clock text-blue-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-blue-800">Data Freshness</h6>
                                <p class="text-blue-700 text-sm">Ensure analysis uses the most current market data available</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-lg border border-orange-200">
                        <h6 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>
                            Important Note
                        </h6>
                        <p class="text-gray-700 text-sm">
                            Corporate Events and Dividend updates will delete existing data and replace with fresh information. 
                            Use these features when you need the most current corporate action data.
                        </p>
                    </div>
                </div>

                <!-- System Workflow -->
                <div id="workflow" class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
                    <h4 class="text-2xl font-bold text-dark mb-6 flex items-center">
                        <i class="fas fa-project-diagram text-red-500 mr-3"></i>
                        System Workflow
                    </h4>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Complete Analysis Workflow</h5>
                        <div class="bg-gray-50 p-6 rounded-lg mb-4">
                            <div class="space-y-4">
                                <!-- Phase 1 -->
                                <div class="border-l-4 border-blue-500 pl-4">
                                    <h6 class="font-semibold text-blue-800">Phase 1: Initialization & Setup</h6>
                                    <p class="text-gray-700 text-sm">System starts analysis by updating VN30 list and initializing Chrome WebDriver pool with anti-detection measures</p>
                                </div>
                                
                                <!-- Phase 2 -->
                                <div class="border-l-4 border-green-500 pl-4">
                                    <h6 class="font-semibold text-green-800">Phase 2: Smart Content Crawling</h6>
                                    <p class="text-gray-700 text-sm">Checks database for existing posts to avoid re-crawling. Uses XPath selectors to extract post content, dates, and titles from configured sources</p>
                                </div>
                                
                                <!-- Phase 3 -->
                                <div class="border-l-4 border-purple-500 pl-4">
                                    <h6 class="font-semibold text-purple-800">Phase 3: AI-Powered Analysis</h6>
                                    <p class="text-gray-700 text-sm">Gemini 2.5-Pro analyzes Vietnamese content to extract stock mentions, industry trends, or macro themes with sentiment scoring</p>
                                </div>
                                
                                <!-- Phase 4 -->
                                <div class="border-l-4 border-orange-500 pl-4">
                                    <h6 class="font-semibold text-orange-800">Phase 4: Contextual Enhancement</h6>
                                    <p class="text-gray-700 text-sm">System maps stocks to industries, searches for related industry sentiment, and incorporates macro-economic context from recent posts</p>
                                </div>
                                
                                <!-- Phase 5 -->
                                <div class="border-l-4 border-red-500 pl-4">
                                    <h6 class="font-semibold text-red-800">Phase 5: Data Enrichment & Results</h6>
                                    <p class="text-gray-700 text-sm">Updates stock prices and company information, then generates comprehensive analysis results combining all contextual factors</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Data Flow Architecture</h5>
                        <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-4 rounded-lg border border-gray-200 mb-4">
                            <p class="text-gray-700 mb-3"><strong>Database-First Approach:</strong></p>
                            <ul class="text-gray-700 text-sm space-y-1">
                                <li> <strong>Source Management:</strong> Configured sources stored in database with type classification</li>
                                <li> <strong>Smart Deduplication:</strong> URL-based checking prevents re-processing existing content</li>
                                <li> <strong>Relational Storage:</strong> Posts linked to stocks, industries, and macro themes with sentiment scores</li>
                                <li> <strong>Aggregated Views:</strong> Daily sentiment aggregations for trend analysis</li>
                                <li> <strong>Price Integration:</strong> Automatic stock price updates for all mentioned stocks</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-lg border border-red-200">
                        <h6 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-cogs text-red-500 mr-2"></i>
                            Performance Optimization
                        </h6>
                        <p class="text-gray-700 text-sm">
                            The system uses thread-safe WebDriver pools, intelligent caching, and selective updates to minimize API calls 
                            and processing time while maintaining data accuracy.
                        </p>
                    </div>
                </div>

                <!-- Technical Details -->
                <div id="technical" class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-8">
                    <h4 class="text-2xl font-bold text-dark mb-6 flex items-center">
                        <i class="fas fa-cogs text-gray-500 mr-3"></i>
                        Technical Details
                    </h4>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Technology Stack</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <i class="fab fa-python text-blue-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-blue-800">Backend</h6>
                                <p class="text-blue-700 text-xs">FastAPI, Selenium, undetected-chromedriver, Google Generative AI</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <i class="fas fa-database text-green-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-green-800">Database</h6>
                                <p class="text-green-700 text-xs">Supabase PostgreSQL with real-time capabilities</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <i class="fab fa-js-square text-purple-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-purple-800">Frontend</h6>
                                <p class="text-purple-700 text-xs">Vanilla JS, TailwindCSS, Chart.js, FontAwesome</p>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                <i class="fas fa-robot text-orange-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-orange-800">AI/ML</h6>
                                <p class="text-orange-700 text-xs">Google Gemini 2.5-Pro for Vietnamese text analysis</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <i class="fas fa-chart-bar text-red-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-red-800">Data Sources</h6>
                                <p class="text-red-700 text-xs">VNStock API for market data and company information</p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                                <i class="fas fa-globe text-indigo-600 text-lg mb-2"></i>
                                <h6 class="font-semibold text-indigo-800">Web Scraping</h6>
                                <p class="text-indigo-700 text-xs">Headless Chrome with stealth anti-detection measures</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Security & Reliability</h5>
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <i class="fas fa-shield-alt text-green-500 mr-3 mt-1"></i>
                                <div>
                                    <strong class="text-gray-800">Anti-Detection Measures:</strong>
                                    <p class="text-gray-600 text-sm">Randomized user agents, disabled automation indicators, stealth Chrome options</p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-sync-alt text-blue-500 mr-3 mt-1"></i>
                                <div>
                                    <strong class="text-gray-800">Error Handling:</strong>
                                    <p class="text-gray-600 text-sm">Graceful degradation, retry logic, quota management for APIs</p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-lock text-purple-500 mr-3 mt-1"></i>
                                <div>
                                    <strong class="text-gray-800">Data Security:</strong>
                                    <p class="text-gray-600 text-sm">Environment variables for API keys, secure database connections</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-dark mb-3">Performance Features</h5>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <ul class="text-gray-700 text-sm space-y-2">
                                <li> <strong>Driver Pool Management:</strong> Thread-safe Chrome WebDriver pool (max 3 drivers)</li>
                                <li> <strong>Smart Caching:</strong> Database-based deduplication to avoid re-processing content</li>
                                <li> <strong>Selective Updates:</strong> Only fetch missing data to optimize API usage</li>
                                <li> <strong>Concurrent Processing:</strong> Parallel API calls and database operations where possible</li>
                                <li> <strong>Memory Optimization:</strong> Headless Chrome with minimal resource footprint</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-gray-50 to-indigo-50 p-4 rounded-lg border border-gray-200">
                        <h6 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <i class="fas fa-code text-indigo-500 mr-2"></i>
                            Development Notes
                        </h6>
                        <p class="text-gray-700 text-sm">
                            The system is designed for high reliability and Vietnamese market specifics. All prompts and analysis 
                            are optimized for Vietnamese language processing, date formats, and local market conventions.
                        </p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-sm p-6 text-white text-center">
                    <div class="mb-4">
                        <i class="fas fa-heart text-red-300 text-2xl mb-2"></i>
                        <p class="text-lg font-semibold">Built with passion for Vietnamese stock market analysis</p>
                    </div>
                    <div class="flex items-center justify-center space-x-6 text-sm text-indigo-100">
                        <div class="flex items-center">
                            <i class="fas fa-database mr-2"></i>
                            <span>Supabase Database</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-robot mr-2"></i>
                            <span>Google Gemini AI</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-chart-line mr-2"></i>
                            <span>VNStock API</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Error Section -->
    <div id="errorBox" class="fixed bottom-6 right-6 max-w-md bg-red-50 border border-red-200 rounded-xl p-4 shadow-lg hidden">
        <div class="flex items-start space-x-3">
            <i class="fas fa-exclamation-triangle text-red-500 text-lg mt-1"></i>
            <div>
                <h4 class="font-semibold text-red-800 mb-1">Error</h4>
                <p id="errorText" class="text-red-600 text-sm"></p>
            </div>
            <button onclick="document.getElementById('errorBox').classList.add('hidden')" class="text-red-400 hover:text-red-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let sources = [];
        let currentEditingIndex = -1;
        let currentStocksData = [];
        const chartInstances = {};

        // DOM elements
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        const sidebarItems = document.querySelectorAll(".sidebar-item");
        const pageTitle = document.getElementById("pageTitle");
        const pageSubtitle = document.getElementById("pageSubtitle");
        
        // Pages
        const newsPage = document.getElementById("newsPage");
        const analyzePage = document.getElementById("analyzePage");
        const companyUpdatePage = document.getElementById("companyUpdatePage");
        const documentsPage = document.getElementById("documentsPage");
        
        // Form elements
        const addNewPageBtn = document.getElementById("addNewPageBtn");
        const newSourceForm = document.getElementById("newSourceForm");
        const sourceForm = document.getElementById("sourceForm");
        const cancelBtn = document.getElementById("cancelBtn");
        const sourcesList = document.getElementById("sourcesList");
        const emptyState = document.getElementById("emptyState");
        const crawlSection = document.getElementById("crawlSection");
        const crawlAllBtn = document.getElementById("crawlAllBtn");
        const crawlText = document.getElementById("crawlText");
        const crawlLoadingIcon = document.getElementById("crawlLoadingIcon");
        const resultsContainer = document.getElementById("resultsContainer");
        const errorBox = document.getElementById("errorBox");
        const errorText = document.getElementById("errorText");
        
        // Dashboard elements
        const crawlDays = document.getElementById("crawlDays");
        const dashboardDays = document.getElementById("dashboardDays");
        const refreshStocksBtn = document.getElementById("refreshStocksBtn");
        const stocksContent = document.getElementById("stocksContent");
        const stocksLoading = document.getElementById("stocksLoading");

        // Mobile menu functionality
        mobileMenuBtn.addEventListener("click", toggleMobileMenu);
        overlay.addEventListener("click", closeMobileMenu);

        function toggleMobileMenu() {
            sidebar.classList.toggle("open");
            overlay.classList.toggle("hidden");
        }

        function closeMobileMenu() {
            sidebar.classList.remove("open");
            overlay.classList.add("hidden");
        }

        // Navigation functionality
        sidebarItems.forEach(item => {
            item.addEventListener("click", (e) => {
                e.preventDefault();
                const page = item.dataset.page;
                
                // Update active state
                sidebarItems.forEach(i => i.classList.remove("active"));
                item.classList.add("active");
                
                // Switch pages
                switchPage(page);
                
                // Close mobile menu
                closeMobileMenu();
            });
        });

        function switchPage(page) {
            // Hide all pages
            document.querySelectorAll(".page-content").forEach(p => p.classList.add("hidden"));
            
            // Show selected page
            if (page === "news") {
                newsPage.classList.remove("hidden");
                pageTitle.textContent = "Market News";
                pageSubtitle.textContent = "Stay updated with the latest Vietnamese stock market insights";
            } else if (page === "analyze") {
                analyzePage.classList.remove("hidden");
                pageTitle.textContent = "Stock Analysis";
                pageSubtitle.textContent = "Configure sources and analyze stock mentions";
            } else if (page === "company-update") {
                companyUpdatePage.classList.remove("hidden");
                pageTitle.textContent = "Company Update";
                pageSubtitle.textContent = "Manual update tools for company information and events data";
            } else if (page === "documents") {
                documentsPage.classList.remove("hidden");
                pageTitle.textContent = "Documentation";
                pageSubtitle.textContent = "Comprehensive guide to understanding and using all features";
            }
        }

        // Event listeners
        addNewPageBtn.addEventListener("click", showNewSourceForm);
        cancelBtn.addEventListener("click", hideNewSourceForm);
        sourceForm.addEventListener("submit", saveSource);
        crawlAllBtn.addEventListener("click", crawlAllSources);
        refreshStocksBtn.addEventListener("click", loadRecentStocks);
        dashboardDays.addEventListener("change", loadRecentStocks);

        // Company Update functionality
        function setupCompanyUpdateEventListeners() {
            const updateCompanyInfoBtn = document.getElementById('updateCompanyInfoBtn');
            if (updateCompanyInfoBtn) {
                updateCompanyInfoBtn.addEventListener('click', updateCompanyInfo);
            }
            
            const updateEventsBtn = document.getElementById('updateCompanyEventsBtn');
            if (updateEventsBtn) {
                updateEventsBtn.addEventListener('click', updateCompanyEvents);
            }
            
            const updateDividendsBtn = document.getElementById('updateCompanyDividendsBtn');
            if (updateDividendsBtn) {
                updateDividendsBtn.addEventListener('click', updateCompanyDividends);
            }
            
            const updateStockPricesBtn = document.getElementById('updateStockPricesBtn');
            if (updateStockPricesBtn) {
                updateStockPricesBtn.addEventListener('click', updateStockPrices);
            }
        }
        
        async function updateCompanyInfo() {
            const button = document.getElementById('updateCompanyInfoBtn');
            const icon = document.getElementById('updateCompanyInfoIcon');
            const text = document.getElementById('updateCompanyInfoText');
            const progressSection = document.getElementById('companyInfoProgressSection');
            const resultsSection = document.getElementById('companyInfoResultsSection');
            const progressBar = document.getElementById('companyInfoProgressBar');
            const progressText = document.getElementById('companyInfoProgressText');
            const progressDetails = document.getElementById('companyInfoProgressDetails');
            
            // Reset UI
            button.disabled = true;
            icon.className = 'fas fa-spinner fa-spin mr-3';
            text.textContent = 'Updating...';
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            progressBar.style.width = '0%';
            
            try {
                // Step 1: Initialize
                progressText.textContent = 'Fetching stock symbols with industry data from VNStock...';
                progressBar.style.width = '20%';
                
                // Step 2: Start the update process
                progressText.textContent = 'Starting company info update...';
                progressBar.style.width = '40%';
                
                const updateResponse = await fetch('/company-info/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.detail || 'Company info update failed');
                }
                
                progressText.textContent = 'Processing update results...';
                progressBar.style.width = '80%';
                
                const resultData = await updateResponse.json();
                
                // Step 3: Display results
                progressText.textContent = 'Company info update completed!';
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    displayCompanyInfoResults(resultData);
                    progressSection.classList.add('hidden');
                    resultsSection.classList.remove('hidden');
                }, 1000);
                
            } catch (error) {
                console.error('Company info update error:', error);
                progressText.textContent = 'Company info update failed';
                progressDetails.textContent = `Error: ${error.message}`;
                progressBar.style.width = '0%';
                
                // Show error in results
                setTimeout(() => {
                    displayCompanyInfoError(error.message);
                    resultsSection.classList.remove('hidden');
                }, 1000);
            } finally {
                // Reset button
                setTimeout(() => {
                    button.disabled = false;
                    icon.className = 'fas fa-sync-alt mr-3';
                    text.textContent = 'Update Company Info';
                }, 2000);
            }
        }
        
        function displayCompanyInfoResults(data) {
            const statsSection = document.getElementById('companyInfoStatsSection');
            const resultsGrid = document.getElementById('companyInfoResultsGrid');
            
            // Display stats summary
            if (data.summary) {
                const summary = data.summary;
                statsSection.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-gray-800">${summary.total_stocks_processed}</div>
                        <div class="text-sm text-gray-600">Total Stocks</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">${summary.successful_updates}</div>
                        <div class="text-sm text-green-700">Successfully Updated</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">${summary.failed_updates}</div>
                        <div class="text-sm text-red-700">Failed Updates</div>
                    </div>
                `;
            }
            
            // Display success message
            resultsGrid.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-check-circle text-green-600"></i>
                        <strong class="text-green-800">Update Successful!</strong>
                    </div>
                    <p class="text-green-700 text-sm">Company information and ICB codes updated for ${data.updated_stocks} stocks</p>
                </div>
            `;
            
            // Show failed stocks if any
            if (data.failed_stocks && data.failed_stocks.length > 0) {
                let failedHTML = '';
                data.failed_stocks.slice(0, 5).forEach(failure => {
                    failedHTML += `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-exclamation-circle text-red-600"></i>
                                <strong class="text-red-800">${failure.symbol || 'Unknown'}</strong>
                            </div>
                            <p class="text-red-700 text-sm">${failure.error}</p>
                        </div>
                    `;
                });
                resultsGrid.innerHTML += failedHTML;
                
                if (data.failed_stocks.length > 5) {
                    resultsGrid.innerHTML += `
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-exclamation-triangle text-amber-600"></i>
                                <strong class="text-amber-800">+${data.failed_stocks.length - 5} more failures</strong>
                            </div>
                            <p class="text-amber-700 text-sm">Check console for details</p>
                        </div>
                    `;
                }
            }
        }
        
        function displayCompanyInfoError(errorMessage) {
            const statsSection = document.getElementById('companyInfoStatsSection');
            const resultsGrid = document.getElementById('companyInfoResultsGrid');
            
            statsSection.innerHTML = `
                <div class="bg-red-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-600"></div>
                    <div class="text-sm text-red-700">Update Failed</div>
                </div>
            `;
            
            resultsGrid.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-exclamation-circle text-red-600"></i>
                        <strong class="text-red-800">Company Info Update Error</strong>
                    </div>
                    <p class="text-red-700 text-sm">${errorMessage}</p>
                </div>
            `;
        }
        
        async function updateCompanyEvents() {
            const button = document.getElementById('updateCompanyEventsBtn');
            const icon = document.getElementById('updateEventsIcon');
            const text = document.getElementById('updateEventsText');
            const progressSection = document.getElementById('eventsProgressSection');
            const resultsSection = document.getElementById('eventsResultsSection');
            const progressBar = document.getElementById('eventsProgressBar');
            const progressText = document.getElementById('eventsProgressText');
            const progressDetails = document.getElementById('eventsProgressDetails');
            
            // Reset UI
            button.disabled = true;
            icon.className = 'fas fa-spinner fa-spin mr-3';
            text.textContent = 'Updating...';
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            progressBar.style.width = '0%';
            
            try {
                // Step 1: Get recent stocks count
                progressText.textContent = 'Getting stocks mentioned in last 30 days...';
                progressBar.style.width = '10%';
                
                const recentStocksResponse = await fetch('/recent-stocks?days=30');
                const recentStocksData = await recentStocksResponse.json();
                const stockCount = recentStocksData.count || 0;
                
                progressDetails.textContent = `Found ${stockCount} stocks to update`;
                progressBar.style.width = '20%';
                
                if (stockCount === 0) {
                    throw new Error('No stocks found in the last 30 days');
                }
                
                // Step 2: Start the update process
                progressText.textContent = 'Starting company events update...';
                progressBar.style.width = '30%';
                
                const updateResponse = await fetch('/company-events/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.detail || 'Update failed');
                }
                
                progressText.textContent = 'Processing update results...';
                progressBar.style.width = '90%';
                
                const resultData = await updateResponse.json();
                
                // Step 3: Display results
                progressText.textContent = 'Update completed!';
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    displayCompanyUpdateResults(resultData);
                    progressSection.classList.add('hidden');
                    resultsSection.classList.remove('hidden');
                }, 1000);
                
            } catch (error) {
                console.error('Update error:', error);
                progressText.textContent = 'Update failed';
                progressDetails.textContent = `Error: ${error.message}`;
                progressBar.style.width = '0%';
                
                // Show error in results
                setTimeout(() => {
                    displayCompanyUpdateError(error.message);
                    resultsSection.classList.remove('hidden');
                }, 1000);
            } finally {
                // Reset button
                setTimeout(() => {
                    button.disabled = false;
                    icon.className = 'fas fa-sync-alt mr-3';
                    text.textContent = 'Update Company Events';
                }, 2000);
            }
        }
        
        function displayCompanyUpdateResults(data) {
            const statsSection = document.getElementById('eventsStatsSection');
            const resultsGrid = document.getElementById('eventsResultsGrid');
            
            // Display stats summary
            if (data.summary) {
                const summary = data.summary;
                statsSection.innerHTML = `
                    <div class="text-center p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                        <div class="text-2xl font-bold text-primary">${summary.total_stocks_processed}</div>
                        <div class="text-sm text-gray-600">Total Stocks</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">${summary.successful_updates}</div>
                        <div class="text-sm text-gray-600">Successful</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-red-50 to-rose-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600">${summary.failed_updates}</div>
                        <div class="text-sm text-gray-600">Failed</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600">${summary.total_events_added}</div>
                        <div class="text-sm text-gray-600">Events Added</div>
                    </div>
                `;
            }
            
            // Display individual stock results
            let resultsHTML = '';
            
            // Successful updates
            if (data.updated_stocks && data.updated_stocks.length > 0) {
                data.updated_stocks.forEach(stock => {
                    const isSuccess = stock.events_count > 0;
                    const bgColor = isSuccess ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200';
                    const textColor = isSuccess ? 'text-green-800' : 'text-yellow-800';
                    const iconColor = isSuccess ? 'text-green-600' : 'text-yellow-600';
                    const icon = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
                    const statusText = isSuccess ? `${stock.events_count} events added` : 'No events found';
                    
                    resultsHTML += `
                        <div class="p-4 ${bgColor} border rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="${icon} ${iconColor}"></i>
                                <div>
                                    <div class="font-semibold ${textColor}">${stock.symbol}</div>
                                    <div class="text-sm text-gray-600">${statusText}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Failed updates
            if (data.failed_stocks && data.failed_stocks.length > 0) {
                data.failed_stocks.forEach(stock => {
                    resultsHTML += `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-times-circle text-red-600"></i>
                                <div>
                                    <div class="font-semibold text-red-800">${stock.symbol}</div>
                                    <div class="text-sm text-gray-600">Error: ${stock.error}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            resultsGrid.innerHTML = resultsHTML;
        }
        
        function displayCompanyUpdateError(errorMessage) {
            const statsSection = document.getElementById('eventsStatsSection');
            const resultsGrid = document.getElementById('eventsResultsGrid');
            
            statsSection.innerHTML = `
                <div class="col-span-full text-center p-6 bg-red-50 border border-red-200 rounded-lg">
                    <div class="text-4xl text-red-500 mb-2"></div>
                    <div class="font-semibold text-red-800">Update Failed</div>
                </div>
            `;
            
            resultsGrid.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-red-600 text-lg mt-0.5"></i>
                        <div>
                            <div class="font-semibold text-red-800">Update Error</div>
                            <div class="text-sm text-gray-600 mt-1">${errorMessage}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Dividends update functionality
        async function updateCompanyDividends() {
            const button = document.getElementById('updateCompanyDividendsBtn');
            const icon = document.getElementById('updateDividendsIcon');
            const text = document.getElementById('updateDividendsText');
            const progressSection = document.getElementById('dividendsProgressSection');
            const resultsSection = document.getElementById('dividendsResultsSection');
            const progressBar = document.getElementById('dividendsProgressBar');
            const progressText = document.getElementById('dividendsProgressText');
            const progressDetails = document.getElementById('dividendsProgressDetails');
            
            // Reset UI
            button.disabled = true;
            icon.className = 'fas fa-spinner fa-spin mr-3';
            text.textContent = 'Updating...';
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            progressBar.style.width = '0%';
            
            try {
                // Step 1: Get recent stocks count
                progressText.textContent = 'Getting stocks mentioned in last 30 days...';
                progressBar.style.width = '10%';
                
                const recentStocksResponse = await fetch('/recent-stocks?days=30');
                const recentStocksData = await recentStocksResponse.json();
                const stockCount = recentStocksData.count || 0;
                
                progressDetails.textContent = `Found ${stockCount} stocks to update`;
                progressBar.style.width = '20%';
                
                if (stockCount === 0) {
                    throw new Error('No stocks found in the last 30 days');
                }
                
                // Step 2: Start the update process
                progressText.textContent = 'Starting company dividends update...';
                progressBar.style.width = '30%';
                
                const updateResponse = await fetch('/company-dividends/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.detail || 'Update failed');
                }
                
                progressText.textContent = 'Processing update results...';
                progressBar.style.width = '90%';
                
                const resultData = await updateResponse.json();
                
                // Step 3: Display results
                progressText.textContent = 'Update completed!';
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    displayCompanyDividendsResults(resultData);
                    progressSection.classList.add('hidden');
                    resultsSection.classList.remove('hidden');
                }, 1000);
                
            } catch (error) {
                console.error('Dividends update error:', error);
                progressText.textContent = 'Update failed';
                progressDetails.textContent = `Error: ${error.message}`;
                progressBar.style.width = '0%';
                
                // Show error in results
                setTimeout(() => {
                    displayCompanyDividendsError(error.message);
                    resultsSection.classList.remove('hidden');
                }, 1000);
            } finally {
                // Reset button
                setTimeout(() => {
                    button.disabled = false;
                    icon.className = 'fas fa-sync-alt mr-3';
                    text.textContent = 'Update Company Dividends';
                }, 2000);
            }
        }

        // Stock prices update functionality
        async function updateStockPrices() {
            const button = document.getElementById('updateStockPricesBtn');
            const icon = document.getElementById('updatePricesIcon');
            const text = document.getElementById('updatePricesText');
            const progressSection = document.getElementById('pricesProgressSection');
            const resultsSection = document.getElementById('pricesResultsSection');
            const progressBar = document.getElementById('pricesProgressBar');
            const progressText = document.getElementById('pricesProgressText');
            const progressDetails = document.getElementById('pricesProgressDetails');

            try {
                // Show loading state
                button.disabled = true;
                icon.className = 'fas fa-spinner fa-spin mr-3';
                text.textContent = 'Updating Stock Prices...';
                progressSection.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                
                progressBar.style.width = '0%';
                progressDetails.textContent = '';

                // Start the update process
                progressText.textContent = 'Checking stocks mentioned in last 7 days...';
                progressBar.style.width = '20%';

                const response = await fetch('/stock-prices/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Update failed');
                }

                progressText.textContent = 'Processing update results...';
                progressBar.style.width = '90%';

                const result = await response.json();

                progressText.textContent = 'Update completed!';
                progressBar.style.width = '100%';

                // Hide progress and show results
                setTimeout(() => {
                    displayStockPricesResults(result);
                    resultsSection.classList.remove('hidden');
                    progressSection.classList.add('hidden');
                }, 1000);

            } catch (error) {
                console.error('Stock prices update error:', error);
                progressText.textContent = 'Update failed';
                progressDetails.textContent = `Error: ${error.message}`;
                progressBar.style.width = '0%';
                
                // Show error in results
                setTimeout(() => {
                    displayStockPricesError(error.message);
                    resultsSection.classList.remove('hidden');
                }, 1000);
            } finally {
                // Reset button
                setTimeout(() => {
                    button.disabled = false;
                    icon.className = 'fas fa-sync-alt mr-3';
                    text.textContent = 'Update Stock Prices';
                }, 2000);
            }
        }
        
        function displayStockPricesResults(data) {
            const statsSection = document.getElementById('pricesStatsSection');
            const resultsGrid = document.getElementById('pricesResultsGrid');
            
            // Display stats
            const details = data.details || {};
            statsSection.innerHTML = `
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600">${data.total_stocks || 0}</div>
                        <div class="text-sm text-gray-600">Total Stocks</div>
                    </div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">${data.stocks_updated || 0}</div>
                        <div class="text-sm text-gray-600">Updated</div>
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">${data.stocks_skipped || 0}</div>
                        <div class="text-sm text-gray-600">Skipped</div>
                    </div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-red-600">${data.stocks_failed || 0}</div>
                        <div class="text-sm text-gray-600">Failed</div>
                    </div>
                </div>
            `;

            // Display individual stock results
            resultsGrid.innerHTML = '';
            if (details && Object.keys(details).length > 0) {
                Object.entries(details).forEach(([symbol, status]) => {
                    const statusColor = status.includes('Updated successfully') ? 'green' : 
                                      status.includes('skipped') ? 'blue' : 'red';
                    const statusIcon = status.includes('Updated successfully') ? 'check-circle' : 
                                     status.includes('skipped') ? 'info-circle' : 'exclamation-triangle';
                    
                    resultsGrid.innerHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-semibold text-lg">${symbol}</span>
                                <i class="fas fa-${statusIcon} text-${statusColor}-500"></i>
                            </div>
                            <p class="text-sm text-gray-600">${status}</p>
                        </div>
                    `;
                });
            }

            // Show message
            if (data.message) {
                resultsGrid.innerHTML += `
                    <div class="col-span-full bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <p class="text-gray-700 text-center">${data.message}</p>
                    </div>
                `;
            }
        }

        function displayStockPricesError(errorMessage) {
            const statsSection = document.getElementById('pricesStatsSection');
            const resultsGrid = document.getElementById('pricesResultsGrid');
            
            statsSection.innerHTML = `
                <div class="col-span-full bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl mb-2"></i>
                        <div class="text-lg font-bold text-red-600">Update Failed</div>
                        <div class="text-sm text-red-500">${errorMessage}</div>
                    </div>
                </div>
            `;
            
            resultsGrid.innerHTML = '';
        }
        
        function displayCompanyDividendsResults(data) {
            const statsSection = document.getElementById('dividendsStatsSection');
            const resultsGrid = document.getElementById('dividendsResultsGrid');
            
            // Display stats summary
            if (data.summary) {
                const summary = data.summary;
                statsSection.innerHTML = `
                    <div class="text-center p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                        <div class="text-2xl font-bold text-primary">${summary.total_stocks_processed}</div>
                        <div class="text-sm text-gray-600">Total Stocks</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">${summary.successful_updates}</div>
                        <div class="text-sm text-gray-600">Successful</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-red-50 to-rose-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600">${summary.failed_updates}</div>
                        <div class="text-sm text-gray-600">Failed</div>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600">${summary.total_dividends_added}</div>
                        <div class="text-sm text-gray-600">Dividends Added</div>
                    </div>
                `;
            }
            
            // Display individual stock results
            let resultsHTML = '';
            
            // Successful updates
            if (data.updated_stocks && data.updated_stocks.length > 0) {
                data.updated_stocks.forEach(stock => {
                    const isSuccess = stock.dividends_count > 0;
                    const bgColor = isSuccess ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200';
                    const textColor = isSuccess ? 'text-green-800' : 'text-yellow-800';
                    const iconColor = isSuccess ? 'text-green-600' : 'text-yellow-600';
                    const icon = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
                    const statusText = isSuccess ? `${stock.dividends_count} dividends added` : 'No dividends found';
                    
                    resultsHTML += `
                        <div class="p-4 ${bgColor} border rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="${icon} ${iconColor}"></i>
                                <div>
                                    <div class="font-semibold ${textColor}">${stock.symbol}</div>
                                    <div class="text-sm text-gray-600">${statusText}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Failed updates
            if (data.failed_stocks && data.failed_stocks.length > 0) {
                data.failed_stocks.forEach(stock => {
                    resultsHTML += `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-times-circle text-red-600"></i>
                                <div>
                                    <div class="font-semibold text-red-800">${stock.symbol}</div>
                                    <div class="text-sm text-gray-600">Error: ${stock.error}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            resultsGrid.innerHTML = resultsHTML;
        }
        
        function displayCompanyDividendsError(errorMessage) {
            const statsSection = document.getElementById('dividendsStatsSection');
            const resultsGrid = document.getElementById('dividendsResultsGrid');
            
            statsSection.innerHTML = `
                <div class="col-span-full text-center p-6 bg-red-50 border border-red-200 rounded-lg">
                    <div class="text-4xl text-red-500 mb-2"></div>
                    <div class="font-semibold text-red-800">Update Failed</div>
                </div>
            `;
            
            resultsGrid.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-red-600 text-lg mt-0.5"></i>
                        <div>
                            <div class="font-semibold text-red-800">Update Error</div>
                            <div class="text-sm text-gray-600 mt-1">${errorMessage}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSourcesFromDatabase();
            loadRecentStocks();
            loadVNIndexChart();
            setupEventListeners();
            setupCompanyUpdateEventListeners();
            
            // Set up company info and price chart button handlers (using event delegation)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.load-company-info-btn')) {
                    e.preventDefault();
                    const btn = e.target.closest('.load-company-info-btn');
                    const symbol = btn.dataset.symbol;
                    console.log('Company Info button clicked for:', symbol);
                    loadCompanyInfo(symbol);
                }
                
                if (e.target.closest('.chart-period-btn')) {
                    e.preventDefault();
                    const btn = e.target.closest('.chart-period-btn');
                    const symbol = btn.dataset.symbol;
                    const period = btn.dataset.period;
                    console.log('Price Chart button clicked for:', symbol, 'period:', period);
                    showPriceChart(symbol, period);
                }
            });
        });

        // VNINDEX Chart functionality
        async function loadVNIndexChart(period = '1M') {
            const loadingEl = document.getElementById('vnindexLoading');
            const errorEl = document.getElementById('vnindexError');
            const canvas = document.getElementById('vnindexChart');

            try {
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');

                // Fetch real VNINDEX data from our API
                const response = await fetch(`/vnindex-data?period=${period}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to fetch VNINDEX data');
                }
                
                // Update price display if elements exist
                const priceEl = document.getElementById('vnindexPrice');
                const changeEl = document.getElementById('vnindexChange');
                
                if (priceEl) {
                    priceEl.textContent = result.latest_price.toFixed(2);
                }
                
                if (changeEl) {
                    const isPositive = result.price_change >= 0;
                    changeEl.innerHTML = `
                        <span class="${isPositive ? 'text-green-600' : 'text-red-600'}">
                            <i class="fas fa-arrow-${isPositive ? 'up' : 'down'} mr-1"></i>
                            ${result.price_change.toFixed(2)} (${result.price_change_percent.toFixed(2)}%)
                        </span>
                    `;
                }

                // Destroy existing chart
                if (chartInstances['vnindex']) {
                    chartInstances['vnindex'].destroy();
                }

                // Create new chart with real data
                const ctx = canvas.getContext('2d');
                chartInstances['vnindex'] = new Chart(ctx, result.chart_config);
                
                console.log(`VNINDEX chart loaded with ${result.data_points} data points for period ${period}`);

                loadingEl.classList.add('hidden');
            } catch (error) {
                console.error('Error loading VN-Index chart:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                
                // Show detailed error message
                if (errorEl) {
                    errorEl.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle text-orange-500 mb-2"></i>
                            <p class="text-sm text-gray-600">
                                Failed to load VNINDEX data: ${error.message}
                            </p>
                        </div>
                    `;
                }
            }
        }

        // VNINDEX period button handlers
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('vnindex-period-btn')) {
                const period = e.target.dataset.period;
                
                // Update button states
                document.querySelectorAll('.vnindex-period-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                });
                
                e.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
                e.target.classList.add('bg-primary', 'text-white');
                
                // Load chart with new period
                loadVNIndexChart(period);
            }
        });


        // Load sources from database
        async function loadSourcesFromDatabase() {
            try {
                const response = await fetch("/sources", {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                sources = result.sources.map(dbSource => ({
                    url: dbSource.url,
                    sourceName: dbSource.name,
                    sourceType: dbSource.source_type || "Company",
                    xpath: dbSource.xpath_title || "",
                    pagination: dbSource.pagination_rule || "",
                    contentXpath: dbSource.xpath_content || "",
                    contentDateXpath: dbSource.xpath_date || "",
                    status: dbSource.status || "active",
                    id: dbSource.id
                }));
                
                updateSourcesList();
            } catch (error) {
                console.error("Error loading sources:", error);
            }
        }

        // Load recent stocks with modern styling
        async function loadRecentStocks() {
            try {
                const days = dashboardDays.value;
                
                stocksLoading.classList.remove("hidden");
                stocksContent.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-3xl text-primary mb-4"></i>
                        <p class="text-gray-500 text-lg">Loading trending stocks...</p>
                    </div>
                `;
                
                const response = await fetch(`/recent-stocks?days=${days}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                // If no real data is available, show empty state
                if (!result.stocks || result.stocks.length === 0) {
                    console.log("No stock data found");
                }
                
                displayRecentStocks(result.stocks, days);
                
            } catch (error) {
                console.error("Error loading recent stocks:", error);
                stocksContent.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
                        <p class="text-gray-500 text-lg">Unable to load stock data</p>
                        <button onclick="loadRecentStocks()" class="mt-4 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function displayRecentStocks(stocks, days) {
            if (!stocks || stocks.length === 0) {
                stocksContent.innerHTML = `
                    <div class="text-center py-16">
                        <i class="fas fa-chart-line text-6xl text-gray-300 mb-6"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No trending stocks found</h3>
                        <p class="text-gray-500 mb-6">No stocks were mentioned in the last ${days} days</p>
                        <button onclick="document.querySelector('[data-page=analyze]').click()" class="bg-primary hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors font-medium">
                            Configure Sources
                        </button>
                    </div>
                `;
                return;
            }

            const stocksHtml = stocks.map(stock => {
                const sentimentColor = getSentimentColor(stock.sentiment);
                
                const postsHtml = (stock.posts || []).map(post => `
                    <div class="bg-white border border-gray-100 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="text-xs font-medium text-primary bg-blue-50 px-2 py-1 rounded-full">${post.source_name}</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${getSentimentColor(post.sentiment)}">
                                        ${post.sentiment}
                                    </span>
                                    <span class="text-xs text-gray-500">${formatDate(post.created_date)}</span>
                                </div>
                                <a href="${post.url}" target="_blank" class="text-sm text-gray-700 hover:text-primary line-clamp-2 leading-relaxed">
                                    ${post.summary}
                                </a>
                            </div>
                            <a href="${post.url}" target="_blank" class="ml-3 text-primary hover:text-blue-600 p-1">
                                <i class="fas fa-external-link-alt text-xs"></i>
                            </a>
                        </div>
                        ${post.stock_mention_summary ? `
                            <div class="text-xs text-gray-600 bg-gray-50 rounded-lg p-3 mt-2">
                                <span class="font-medium text-dark">About ${stock.symbol}:</span> ${post.stock_mention_summary}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
                return `
                    <div class="bg-white border border-gray-100 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center">
                                    <span class="text-white font-bold text-lg">${stock.symbol}</span>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-dark">${stock.symbol}</h3>
                                    ${stock.isvn30 ? '<span class="inline-flex items-center px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full border border-yellow-200"><i class="fas fa-star mr-1"></i>VN30</span>' : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium ${sentimentColor}">
                                        ${stock.sentiment}
                                    </span>
                                </div>
                                <p class="text-xs text-gray-500">${stock.posts_count} posts</p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 leading-relaxed">
                                <strong>${stock.name}</strong>  ${stock.exchange}
                            </p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-4">
                            <h4 class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                <i class="fas fa-chart-line mr-2"></i>Market Sentiment
                            </h4>
                            <p class="text-sm text-blue-700 leading-relaxed">
                                ${stock.summary || 'No analysis summary available'}
                            </p>
                        </div>
                        
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-dark flex items-center">
                                    <i class="fas fa-newspaper mr-2 text-primary"></i>Recent Posts
                                </h4>
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs font-medium">
                                    ${stock.posts_count}
                                </span>
                            </div>
                            <div class="max-h-80 overflow-y-auto space-y-2">
                                ${postsHtml || '<p class="text-sm text-gray-500 italic text-center py-4">No posts available</p>'}
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-100 mt-4">
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span>Last updated: ${formatDate(stock.last_updated)}</span>
                                <div class="flex items-center space-x-4">
                                    <button class="load-company-info-btn text-primary hover:text-blue-600 font-medium" data-symbol="${stock.symbol}">
                                        <i class="fas fa-info-circle mr-1"></i>Company Info
                                    </button>
                                    <button class="chart-period-btn text-primary hover:text-blue-600 font-medium" data-period="1m" data-symbol="${stock.symbol}">
                                        <i class="fas fa-chart-area mr-1"></i>Price Chart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            stocksContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${stocksHtml}
                </div>
                <div class="text-center mt-8 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">
                        Showing <span class="font-semibold text-dark">${stocks.length}</span> trending stocks from the last <span class="font-semibold text-dark">${days}</span> days
                    </p>
                </div>
            `;

            // Store data for filtering
            currentStocksData = stocks;
        }

        // Form handling functions
        function showNewSourceForm(isEdit = false) {
            newSourceForm.classList.remove("hidden");
            addNewPageBtn.style.display = "none";
            
            // Only reset form if it's a new source, not an edit
            if (!isEdit) {
                sourceForm.reset();
                currentEditingIndex = -1;
            }
            
            // Update form title based on mode
            const formTitle = newSourceForm.querySelector('h4');
            if (isEdit && currentEditingIndex >= 0) {
                formTitle.innerHTML = '<i class="fas fa-edit mr-2 text-primary"></i>Edit Source';
            } else {
                formTitle.innerHTML = '<i class="fas fa-plus-circle mr-2 text-primary"></i>Configure New Source';
            }
        }

        function hideNewSourceForm() {
            newSourceForm.classList.add("hidden");
            addNewPageBtn.style.display = "block";
            sourceForm.reset();
            currentEditingIndex = -1;
        }

        async function saveSource(e) {
            e.preventDefault();
            
            const formData = new FormData(sourceForm);
            const sourceData = {
                url: formData.get("url"),
                sourceName: formData.get("sourceName"),
                sourceType: formData.get("sourceType"),
                xpath: formData.get("xpath"),
                pagination: formData.get("paginationRule"),
                contentXpath: formData.get("contentXpath"),
                contentDateXpath: formData.get("contentDateXpath"),
            };

            const isEditing = currentEditingIndex >= 0;
            const sourceId = isEditing ? sources[currentEditingIndex].id : null;

            try {
                let response;
                
                if (isEditing) {
                    // Update existing source
                    console.log(`Updating source ${sourceId}:`, sourceData);
                    response = await fetch(`/sources/${sourceId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(sourceData),
                        mode: 'cors'
                    });
                } else {
                    // Create new source
                    console.log("Creating new source:", sourceData);
                    response = await fetch("/sources", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(sourceData),
                        mode: 'cors'
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Save result:', result);
                
                // Show success message
                const action = isEditing ? 'updated' : 'saved';
                showSuccess(`Source "${sourceData.sourceName}" ${action} successfully`);
                
                await loadSourcesFromDatabase();
                hideNewSourceForm();
                
            } catch (error) {
                console.error("Error saving source:", error);
                showError(`Failed to save source: ${error.message}`);
            }
        }

        function updateSourcesList() {
            if (sources.length === 0) {
                emptyState.classList.remove("hidden");
                crawlSection.classList.add("hidden");
                return;
            }

            emptyState.classList.add("hidden");
            crawlSection.classList.remove("hidden");

            sourcesList.innerHTML = sources.map((source, index) => {
                const isActive = source.status === 'active';
                const statusColor = isActive ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200';
                const statusText = isActive ? 'Active' : 'Inactive';
                
                return `
                    <div class="bg-white border border-gray-100 rounded-xl p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-4 mb-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center">
                                        <i class="fas fa-globe text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-dark text-lg">${source.sourceName}</h4>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-lg text-xs font-medium">
                                                ${source.sourceType || 'Company'}
                                            </span>
                                            <span class="px-2 py-1 ${statusColor} rounded-lg text-xs font-medium border">
                                                ${statusText}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 break-all bg-gray-50 p-2 rounded-lg">
                                    <i class="fas fa-link mr-2 text-primary"></i>${source.url}
                                </p>
                            </div>
                            <div class="flex items-center space-x-3 ml-6">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" ${isActive ? 'checked' : ''} 
                                           onchange="toggleSourceStatus(${index})"
                                           class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                                
                                <div class="flex space-x-2">
                                    <button onclick="editSource(${index})" 
                                            class="text-primary hover:text-blue-600 p-2 hover:bg-blue-50 rounded-lg transition-colors">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteSource(${index})" 
                                            class="text-red-500 hover:text-red-600 p-2 hover:bg-red-50 rounded-lg transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleSourceStatus(index) {
            const source = sources[index];
            const newStatus = source.status === 'active' ? 'inactive' : 'active';
            
            try {
                const response = await fetch(`/sources/${source.id}/status`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: newStatus }),
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                sources[index].status = newStatus;
                updateSourcesList();
                
            } catch (error) {
                console.error("Error updating source status:", error);
                updateSourcesList(); // Revert UI
                showError(`Failed to update source status: ${error.message}`);
            }
        }

        function editSource(index) {
            const source = sources[index];
            
            if (!source) {
                console.error('Source not found at index:', index);
                return;
            }
            
            currentEditingIndex = index;
            
            if (!sourceForm) {
                console.error('sourceForm not found');
                return;
            }
            
            try {
                // Use querySelector method for reliable form field access
                const fields = [
                    {name: 'sourceName', value: source.sourceName},
                    {name: 'sourceType', value: source.sourceType},
                    {name: 'url', value: source.url},
                    {name: 'xpath', value: source.xpath || ''},
                    {name: 'paginationRule', value: source.pagination || ''},
                    {name: 'contentXpath', value: source.contentXpath || ''},
                    {name: 'contentDateXpath', value: source.contentDateXpath || ''}
                ];
                
                fields.forEach(field => {
                    const element = sourceForm.querySelector(`[name="${field.name}"]`);
                    if (element) {
                        element.value = field.value;
                    }
                });
                
                showNewSourceForm(true);
                
            } catch (error) {
                console.error('Error in editSource:', error);
                showError('Failed to load source for editing');
            }
        }

        async function deleteSource(index) {
            const source = sources[index];
            if (!confirm(`Are you sure you want to delete "${source.sourceName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/sources/${source.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP error! status: ${response.status}`);
                }
                
                // Remove from frontend array
                sources.splice(index, 1);
                updateSourcesList();
                
                showSuccess(`Source "${source.sourceName}" deleted successfully`);
                
            } catch (error) {
                console.error('Error deleting source:', error);
                showError(`Failed to delete source: ${error.message}`);
            }
        }

        async function crawlAllSources() {
            const activeSources = sources.filter(source => source.status === 'active');
            
            if (activeSources.length === 0) {
                showError('No active sources found. Please add sources and make sure they are active.');
                return;
            }

            resultsContainer.classList.add("hidden");
            crawlText.innerHTML = `<i class="fas fa-spinner fa-spin mr-3"></i>Analyzing ${activeSources.length} Sources...`;
            crawlAllBtn.disabled = true;

            try {
                const selectedDays = parseInt(crawlDays.value);
                
                const response = await fetch("/crawl-multiple", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        sources: activeSources,
                        days: selectedDays
                    }),
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                displayResults(result);

            } catch (error) {
                console.error("Error during analysis:", error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                crawlText.innerHTML = '<i class="fas fa-rocket mr-3"></i>Start Analysis';
                crawlAllBtn.disabled = false;
            }
        }

        function displayResults(data) {
            // Implementation would be similar to the original displayResults function
            // but with the new styling applied
            resultsContainer.classList.remove("hidden");
            
            // For now, just show a success message
            const metadataContent = document.getElementById("metadataContent");
            if (data.metadata) {
                metadataContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${data.metadata.sources_analyzed || 0}</div>
                            <div class="text-sm text-blue-800">Sources Analyzed</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${data.metadata.total_posts_analyzed || 0}</div>
                            <div class="text-sm text-green-800">Posts Analyzed</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600">${data.metadata.unique_stocks_found || 0}</div>
                            <div class="text-sm text-purple-800">Stocks Found</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600">${data.metadata.success_rate || 'N/A'}</div>
                            <div class="text-sm text-yellow-800">Success Rate</div>
                        </div>
                    </div>
                `;
            }
        }

        // Helper functions
        function getSentimentColor(sentiment) {
            switch (sentiment?.toLowerCase()) {
                case 'positive': return 'bg-green-100 text-green-800 border-green-200';
                case 'negative': return 'bg-red-100 text-red-800 border-red-200';
                case 'neutral': return 'bg-gray-100 text-gray-800 border-gray-200';
                default: return 'bg-gray-100 text-gray-800 border-gray-200';
            }
        }

        function formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch {
                return dateString;
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorBox.classList.remove("hidden");
            setTimeout(() => {
                errorBox.classList.add("hidden");
            }, 5000);
        }

        function showSuccess(message) {
            // Create a temporary success message element
            const successBox = document.createElement('div');
            successBox.className = 'fixed top-4 right-4 z-50 bg-green-50 border border-green-200 text-green-800 px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 transition-all duration-300';
            successBox.innerHTML = `
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
                <div class="flex-grow">
                    <p class="font-medium">${message}</p>
                </div>
            `;
            
            document.body.appendChild(successBox);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                successBox.style.opacity = '0';
                successBox.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (successBox.parentNode) {
                        successBox.parentNode.removeChild(successBox);
                    }
                }, 300);
            }, 3000);
        }

        // Filter functionality (simplified for now)
        function setupEventListeners() {
            document.getElementById('stockSearch')?.addEventListener('input', applyFilters);
            document.getElementById('sentimentFilter')?.addEventListener('change', applyFilters);
            document.getElementById('vn30Filter')?.addEventListener('change', applyFilters);
            document.getElementById('sortBy')?.addEventListener('change', applyFilters);
            document.getElementById('sortOrder')?.addEventListener('change', applyFilters);
            document.getElementById('clearFilters')?.addEventListener('click', clearFilters);
        }

        function applyFilters() {
            // Filter implementation would go here
            // For now, just reload the stocks
            if (currentStocksData.length > 0) {
                displayRecentStocks(currentStocksData, dashboardDays.value);
            }
        }

        function clearFilters() {
            document.getElementById('stockSearch').value = '';
            document.getElementById('sentimentFilter').value = '';
            document.getElementById('vn30Filter').value = '';
            document.getElementById('sortBy').value = 'posts_count';
            document.getElementById('sortOrder').value = 'desc';
            applyFilters();
        }
        
        // Company info functionality
        async function loadCompanyInfo(symbol) {
            try {
                console.log(`Loading company info for ${symbol}`);
                showToast(`Loading company information for ${symbol}...`, 'info');
                
                const response = await fetch(`/company-info/${symbol}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load company information');
                }
                
                // Display company info in a modal or popup
                showCompanyInfoModal(symbol, result.company_info);
                showToast(`Company information loaded successfully!`, 'success');
                
            } catch (error) {
                console.error('Error loading company info:', error);
                showToast(`Failed to load company info for ${symbol}: ${error.message}`, 'error');
            }
        }
        
        // Price chart functionality
        async function showPriceChart(symbol, period = '1m') {
            try {
                console.log(`Loading price chart for ${symbol} (${period})`);
                showToast(`Loading price chart for ${symbol}...`, 'info');
                
                const response = await fetch(`/stock-prices/${symbol}?period=${period}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to load price data');
                }
                
                // Display price chart in a modal
                showPriceChartModal(symbol, result, period);
                showToast(`Price chart loaded successfully!`, 'success');
                
            } catch (error) {
                console.error('Error loading price chart:', error);
                showToast(`Failed to load price chart for ${symbol}: ${error.message}`, 'error');
            }
        }
        
        // Modal functions
        function showCompanyInfoModal(symbol, companyInfo) {
            const modal = createModal(`${symbol} - Company Information`, `
                <div class="space-y-6">
                    <!-- Overview -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">Company Overview</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Name:</span>
                                <span class="ml-2 font-medium">${companyInfo.overview?.name || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Exchange:</span>
                                <span class="ml-2 font-medium">${companyInfo.overview?.exchange || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Issue Share:</span>
                                <span class="ml-2 font-medium">${companyInfo.overview?.issue_share?.toLocaleString() || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Charter Capital:</span>
                                <span class="ml-2 font-medium">${companyInfo.overview?.charter_capital?.toLocaleString() || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Events -->
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-3">Recent Events</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${companyInfo.recent_events?.map(event => `
                                <div class="bg-white p-3 rounded border text-sm">
                                    <div class="font-medium">${event.event_name || 'Event'}</div>
                                    <div class="text-gray-600">${event.event_date || 'N/A'}</div>
                                    ${event.description ? `<div class="mt-1 text-gray-700">${event.description}</div>` : ''}
                                </div>
                            `).join('') || '<div class="text-gray-500 text-center py-4">No recent events</div>'}
                        </div>
                    </div>
                    
                    <!-- Recent Dividends -->
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-3">Recent Dividends</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${companyInfo.recent_dividends?.map(dividend => `
                                <div class="bg-white p-3 rounded border text-sm">
                                    <div class="flex justify-between">
                                        <div class="font-medium">Year ${dividend.cash_year || 'N/A'}</div>
                                        <div class="text-green-600 font-semibold">${dividend.cash_dividend_percentage || 0}%</div>
                                    </div>
                                    <div class="text-gray-600">${dividend.exercise_date || 'N/A'}</div>
                                </div>
                            `).join('') || '<div class="text-gray-500 text-center py-4">No recent dividends</div>'}
                        </div>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }
        
        function showPriceChartModal(symbol, chartData, currentPeriod = '1m') {
            let currentChart = null; // Store the current chart instance
            
            const modal = createModal(`${symbol} - Price Chart (${chartData.period})`, `
                <div class="space-y-4">
                    <!-- Period Selection -->
                    <div class="flex items-center justify-between">
                        <h4 class="font-semibold text-gray-800">Select Period</h4>
                        <div class="flex rounded-lg border border-gray-200 overflow-hidden">
                            <button class="period-selector-btn px-4 py-2 text-sm font-medium transition-colors ${currentPeriod === '1m' ? 'bg-primary text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}" data-period="1m" data-symbol="${symbol}">
                                1 Month
                            </button>
                            <button class="period-selector-btn px-4 py-2 text-sm font-medium border-l border-gray-200 transition-colors ${currentPeriod === '3m' ? 'bg-primary text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}" data-period="3m" data-symbol="${symbol}">
                                3 Months
                            </button>
                            <button class="period-selector-btn px-4 py-2 text-sm font-medium border-l border-gray-200 transition-colors ${currentPeriod === '1y' ? 'bg-primary text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}" data-period="1y" data-symbol="${symbol}">
                                1 Year
                            </button>
                        </div>
                    </div>
                    
                    <!-- Price Stats -->
                    <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <div class="text-sm text-gray-600">Data Points</div>
                            <div class="text-lg font-semibold">${chartData.data_points || 0}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600">Period</div>
                            <div class="text-lg font-semibold">${chartData.period}</div>
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="chartLoadingIndicator" class="hidden text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl text-primary mb-2"></i>
                        <div class="text-gray-600">Loading chart data...</div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div id="chartContainer" class="relative h-80">
                        <canvas id="modalPriceChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
            
            // Set up period selector event listeners
            modal.querySelectorAll('.period-selector-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const newPeriod = btn.dataset.period;
                    const symbol = btn.dataset.symbol;
                    
                    // Update button states
                    modal.querySelectorAll('.period-selector-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50');
                    });
                    btn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
                    btn.classList.add('bg-primary', 'text-white');
                    
                    // Show loading and hide chart
                    const loadingIndicator = modal.querySelector('#chartLoadingIndicator');
                    const chartContainer = modal.querySelector('#chartContainer');
                    loadingIndicator.classList.remove('hidden');
                    chartContainer.classList.add('hidden');
                    
                    try {
                        // Fetch new data
                        const response = await fetch(`/stock-prices/${symbol}?period=${newPeriod}`);
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.message || 'Failed to load price data');
                        }
                        
                        // Update modal title
                        const titleElement = modal.querySelector('.modal-title');
                        if (titleElement) {
                            titleElement.textContent = `${symbol} - Price Chart (${result.period})`;
                        }
                        
                        // Update stats
                        const statsElements = modal.querySelectorAll('.grid .text-lg.font-semibold');
                        if (statsElements[0]) statsElements[0].textContent = result.data_points || 0;
                        if (statsElements[1]) statsElements[1].textContent = result.period;
                        
                        // Create new chart
                        const canvas = modal.querySelector('#modalPriceChart');
                        if (canvas && result.chart_config) {
                            // Destroy existing chart if it exists
                            if (currentChart) {
                                currentChart.destroy();
                                currentChart = null;
                            }
                            
                            // Create new chart instance
                            const ctx = canvas.getContext('2d');
                            currentChart = new Chart(ctx, result.chart_config);
                        }
                        
                        // Show chart and hide loading
                        loadingIndicator.classList.add('hidden');
                        chartContainer.classList.remove('hidden');
                        
                    } catch (error) {
                        console.error('Error updating chart:', error);
                        loadingIndicator.innerHTML = `
                            <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-2"></i>
                            <div class="text-red-600">Failed to load chart data</div>
                        `;
                    }
                });
            });
            
            // Create initial chart after modal is added to DOM
            setTimeout(() => {
                const canvas = document.getElementById('modalPriceChart');
                if (canvas && chartData.chart_config) {
                    currentChart = new Chart(canvas.getContext('2d'), chartData.chart_config);
                }
            }, 100);
            
            // Clean up chart when modal is closed
            const originalRemove = modal.remove;
            modal.remove = function() {
                if (currentChart) {
                    currentChart.destroy();
                    currentChart = null;
                }
                originalRemove.call(this);
            };
        }
        
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between p-6 border-b border-gray-100">
                        <h3 class="modal-title text-lg font-semibold text-gray-800">${title}</h3>
                        <button class="modal-close-btn text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        ${content}
                    </div>
                </div>
            `;
            
            // Close modal handlers
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.closest('.modal-close-btn')) {
                    modal.remove();
                }
            });
            
            // Add ESC key support
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            return modal;
        }

        // Simple toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>