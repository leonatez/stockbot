<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNStock Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2F80ED',
                        secondary: '#4154F1',
                        accent: '#6C63FF',
                        light: '#F5F6FA',
                        medium: '#C4C4C4',
                        dark: '#333333'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        }
    </script>
    
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .sidebar-item {
            transition: all 0.2s ease-in-out;
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #2F80ED 0%, #4154F1 100%);
            color: white;
            border-left: 4px solid #fff;
        }
        
        .sidebar-item:hover:not(.active) {
            background-color: #F5F6FA;
            transform: translateX(4px);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="bg-light font-sans">
    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="fixed top-4 left-4 z-50 md:hidden bg-primary text-white p-3 rounded-lg shadow-lg">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 bg-white shadow-xl z-40 md:translate-x-0">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-dark">VNStock</h1>
                    <p class="text-sm text-gray-500">Analyzer</p>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="p-4">
            <ul class="space-y-2">
                <li>
                    <a href="#" class="sidebar-item active flex items-center space-x-3 p-3 rounded-lg font-medium" data-page="news">
                        <i class="fas fa-newspaper text-lg"></i>
                        <span>News</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg font-medium" data-page="analyze">
                        <i class="fas fa-analytics text-lg"></i>
                        <span>Analyze</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <!-- User Info -->
        <div class="absolute bottom-0 w-full p-4 border-t border-gray-100">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-dark">Stock Trader</p>
                    <p class="text-xs text-gray-500">Premium User</p>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Overlay for mobile -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    
    <!-- Main Content -->
    <main class="md:ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-100 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 id="pageTitle" class="text-2xl font-bold text-dark">Market News</h2>
                    <p id="pageSubtitle" class="text-gray-500 mt-1">Stay updated with the latest Vietnamese stock market insights</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="p-2 text-gray-400 hover:text-primary transition-colors">
                        <i class="fas fa-bell text-lg"></i>
                    </button>
                    <button class="p-2 text-gray-400 hover:text-primary transition-colors">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="p-6">
            <!-- News Page -->
            <div id="newsPage" class="page-content">
                <!-- VNINDEX Chart Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-dark flex items-center">
                                <i class="fas fa-chart-area text-primary mr-3"></i>
                                VN-Index Performance
                            </h3>
                            <p class="text-gray-500 mt-1">Vietnam's benchmark stock index</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="vnindex-period-btn px-4 py-2 text-sm font-medium rounded-lg bg-primary text-white" data-period="1M">1M</button>
                            <button class="vnindex-period-btn px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-period="3M">3M</button>
                            <button class="vnindex-period-btn px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-period="6M">6M</button>
                            <button class="vnindex-period-btn px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-period="1Y">1Y</button>
                        </div>
                    </div>
                    
                    <!-- Price Display -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Current Value</p>
                                <p class="text-2xl font-bold text-dark" id="vnindexPrice">-</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Change</p>
                                <div id="vnindexChange" class="text-lg font-semibold">
                                    <span class="text-gray-400">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative h-80">
                        <canvas id="vnindexChart" class="w-full h-full"></canvas>
                        <div id="vnindexLoading" class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-2xl text-primary mb-2"></i>
                                <p class="text-gray-500">Loading VN-Index data...</p>
                            </div>
                        </div>
                        <div id="vnindexError" class="absolute inset-0 flex items-center justify-center hidden">
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-2"></i>
                                <p class="text-gray-500">Unable to load VN-Index data</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Stock Activity -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-dark flex items-center">
                                <i class="fas fa-fire text-red-500 mr-3"></i>
                                Trending Stocks
                            </h3>
                            <p class="text-gray-500 mt-1">Most mentioned stocks in recent news</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label for="dashboardDays" class="text-sm font-medium text-gray-700">Period:</label>
                            <select id="dashboardDays" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="1">1 day</option>
                                <option value="3" selected>3 days</option>
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                            </select>
                            <button id="refreshStocksBtn" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="bg-light rounded-lg p-4 mb-6">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-search mr-1 text-primary"></i>Search:
                                </label>
                                <input 
                                    id="stockSearch" 
                                    type="text" 
                                    placeholder="Enter stock symbol..." 
                                    class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent w-40"
                                >
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-smile mr-1 text-primary"></i>Sentiment:
                                </label>
                                <select id="sentimentFilter" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">All</option>
                                    <option value="positive">Positive</option>
                                    <option value="neutral">Neutral</option>
                                    <option value="negative">Negative</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-star mr-1 text-yellow-500"></i>VN30:
                                </label>
                                <select id="vn30Filter" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">All</option>
                                    <option value="true">VN30 Only</option>
                                    <option value="false">Non-VN30</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">
                                    <i class="fas fa-sort mr-1 text-primary"></i>Sort by:
                                </label>
                                <select id="sortBy" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="posts_count">Post Count</option>
                                    <option value="symbol">Symbol</option>
                                    <option value="last_updated">Date</option>
                                    <option value="sentiment">Sentiment</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <select id="sortOrder" class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="desc">Descending</option>
                                    <option value="asc">Ascending</option>
                                </select>
                            </div>
                            
                            <button id="clearFilters" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                <i class="fas fa-times mr-1"></i>Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stocks Content -->
                    <div id="stocksContent">
                        <div id="stocksLoading" class="text-center py-12">
                            <i class="fas fa-spinner fa-spin text-3xl text-primary mb-4"></i>
                            <p class="text-gray-500 text-lg">Loading trending stocks...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analyze Page -->
            <div id="analyzePage" class="page-content hidden">
                <!-- Data Sources Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-dark flex items-center">
                                <i class="fas fa-globe text-primary mr-3"></i>
                                Data Sources
                            </h3>
                            <p class="text-gray-500 mt-1">Configure news sources for stock analysis</p>
                        </div>
                        <button id="addNewPageBtn" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors font-medium">
                            <i class="fas fa-plus mr-2"></i>Add New Source
                        </button>
                    </div>

                    <!-- Sources List -->
                    <div id="sourcesList" class="space-y-4 mb-6">
                        <div id="emptyState" class="text-center py-12">
                            <i class="fas fa-plus-circle text-4xl text-gray-300 mb-4"></i>   
                            <p class="text-gray-500 text-lg">No sources configured yet</p>
                            <p class="text-gray-400 text-sm">Click "Add New Source" to get started</p>
                        </div>
                    </div>

                    <!-- New Source Form -->
                    <div id="newSourceForm" class="hidden border-t border-gray-100 pt-6">
                        <h4 class="text-lg font-semibold text-dark mb-4">
                            <i class="fas fa-plus-circle mr-2 text-primary"></i>Configure New Source
                        </h4>
                        <form id="sourceForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Source Name</label>
                                    <input type="text" name="sourceName"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="e.g., ACBS Research" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Source Type</label>
                                    <select name="sourceType"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option>Company</option>
                                        <option>Industry</option>
                                        <option>Macro Economy</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-dark mb-2">URL</label>
                                <input type="text" name="url"
                                    class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                    placeholder="https://example.com/news" required />
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">XPath for Posts</label>
                                    <input type="text" name="xpath"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="//a[@class='post-link']" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Pagination Rule</label>
                                    <input type="text" name="paginationRule"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="/page/{}" />
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Content XPath</label>
                                    <input type="text" name="contentXpath"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="//div[@class='content']" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-dark mb-2">Date XPath</label>
                                    <input type="text" name="contentDateXpath"
                                        class="w-full border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                        placeholder="//span[@class='date']" />
                                </div>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-100">
                                <button type="button" id="cancelBtn" class="px-6 py-3 border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                    Cancel
                                </button>
                                <button type="submit" class="px-6 py-3 bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors font-medium">
                                    Save Source
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Analysis Controls -->
                    <div id="crawlSection" class="hidden border-t border-gray-100 pt-6">
                        <div class="bg-gradient-to-r from-primary to-secondary p-6 rounded-xl text-white">
                            <div class="text-center">
                                <h4 class="text-xl font-bold mb-2">Ready to Analyze</h4>
                                <p class="text-blue-100 mb-6">Start crawling and analyzing your configured sources</p>
                                
                                <div class="flex items-center justify-center space-x-6 mb-6">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-calendar-alt text-xl"></i>
                                        <label for="crawlDays" class="font-medium">Analyze posts from last:</label>
                                    </div>
                                    <select id="crawlDays" class="bg-white text-dark border-0 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white">
                                        <option value="1">1 day</option>
                                        <option value="3" selected>3 days</option>
                                        <option value="7">7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                                
                                <button id="crawlAllBtn" class="bg-white text-primary hover:bg-gray-100 px-8 py-4 rounded-lg transition-colors text-lg font-semibold shadow-lg">
                                    <span id="crawlText">
                                        <i class="fas fa-rocket mr-3"></i>Start Analysis
                                    </span>
                                    <i id="crawlLoadingIcon" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsContainer" class="hidden space-y-6">
                    <!-- Metadata Section -->
                    <div id="metadataSection" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-xl font-bold text-dark mb-4">
                            <i class="fas fa-info-circle mr-2 text-primary"></i>Analysis Summary
                        </h3>
                        <div id="metadataContent" class="text-gray-700"></div>
                    </div>

                    <!-- Stock Analysis Section -->
                    <div id="stockAnalysisSection">
                        <h3 class="text-2xl font-bold text-dark mb-6 text-center">
                            <i class="fas fa-chart-line mr-3 text-primary"></i>Stock Analysis Results
                        </h3>
                        <div id="stockAnalysisContent" class="space-y-6"></div>
                    </div>

                    <!-- Individual Posts Section -->
                    <div id="postsSection" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-xl font-bold text-dark mb-4">
                            <i class="fas fa-newspaper mr-2 text-primary"></i>Analyzed Posts
                        </h3>
                        <div id="postsContent" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Error Section -->
    <div id="errorBox" class="fixed bottom-6 right-6 max-w-md bg-red-50 border border-red-200 rounded-xl p-4 shadow-lg hidden">
        <div class="flex items-start space-x-3">
            <i class="fas fa-exclamation-triangle text-red-500 text-lg mt-1"></i>
            <div>
                <h4 class="font-semibold text-red-800 mb-1">Error</h4>
                <p id="errorText" class="text-red-600 text-sm"></p>
            </div>
            <button onclick="document.getElementById('errorBox').classList.add('hidden')" class="text-red-400 hover:text-red-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let sources = [];
        let currentEditingIndex = -1;
        let currentStocksData = [];
        const chartInstances = {};

        // DOM elements
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        const sidebarItems = document.querySelectorAll(".sidebar-item");
        const pageTitle = document.getElementById("pageTitle");
        const pageSubtitle = document.getElementById("pageSubtitle");
        
        // Pages
        const newsPage = document.getElementById("newsPage");
        const analyzePage = document.getElementById("analyzePage");
        
        // Form elements
        const addNewPageBtn = document.getElementById("addNewPageBtn");
        const newSourceForm = document.getElementById("newSourceForm");
        const sourceForm = document.getElementById("sourceForm");
        const cancelBtn = document.getElementById("cancelBtn");
        const sourcesList = document.getElementById("sourcesList");
        const emptyState = document.getElementById("emptyState");
        const crawlSection = document.getElementById("crawlSection");
        const crawlAllBtn = document.getElementById("crawlAllBtn");
        const crawlText = document.getElementById("crawlText");
        const crawlLoadingIcon = document.getElementById("crawlLoadingIcon");
        const resultsContainer = document.getElementById("resultsContainer");
        const errorBox = document.getElementById("errorBox");
        const errorText = document.getElementById("errorText");
        
        // Dashboard elements
        const crawlDays = document.getElementById("crawlDays");
        const dashboardDays = document.getElementById("dashboardDays");
        const refreshStocksBtn = document.getElementById("refreshStocksBtn");
        const stocksContent = document.getElementById("stocksContent");
        const stocksLoading = document.getElementById("stocksLoading");

        // Mobile menu functionality
        mobileMenuBtn.addEventListener("click", toggleMobileMenu);
        overlay.addEventListener("click", closeMobileMenu);

        function toggleMobileMenu() {
            sidebar.classList.toggle("open");
            overlay.classList.toggle("hidden");
        }

        function closeMobileMenu() {
            sidebar.classList.remove("open");
            overlay.classList.add("hidden");
        }

        // Navigation functionality
        sidebarItems.forEach(item => {
            item.addEventListener("click", (e) => {
                e.preventDefault();
                const page = item.dataset.page;
                
                // Update active state
                sidebarItems.forEach(i => i.classList.remove("active"));
                item.classList.add("active");
                
                // Switch pages
                switchPage(page);
                
                // Close mobile menu
                closeMobileMenu();
            });
        });

        function switchPage(page) {
            // Hide all pages
            document.querySelectorAll(".page-content").forEach(p => p.classList.add("hidden"));
            
            // Show selected page
            if (page === "news") {
                newsPage.classList.remove("hidden");
                pageTitle.textContent = "Market News";
                pageSubtitle.textContent = "Stay updated with the latest Vietnamese stock market insights";
            } else if (page === "analyze") {
                analyzePage.classList.remove("hidden");
                pageTitle.textContent = "Stock Analysis";
                pageSubtitle.textContent = "Configure sources and analyze stock mentions";
            }
        }

        // Event listeners
        addNewPageBtn.addEventListener("click", showNewSourceForm);
        cancelBtn.addEventListener("click", hideNewSourceForm);
        sourceForm.addEventListener("submit", saveSource);
        crawlAllBtn.addEventListener("click", crawlAllSources);
        refreshStocksBtn.addEventListener("click", loadRecentStocks);
        dashboardDays.addEventListener("change", loadRecentStocks);

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSourcesFromDatabase();
            loadRecentStocks();
            loadVNIndexChart();
            setupEventListeners();
            
            // Set up company info and price chart button handlers (using event delegation)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.load-company-info-btn')) {
                    e.preventDefault();
                    const btn = e.target.closest('.load-company-info-btn');
                    const symbol = btn.dataset.symbol;
                    console.log('Company Info button clicked for:', symbol);
                    loadCompanyInfo(symbol);
                }
                
                if (e.target.closest('.chart-period-btn')) {
                    e.preventDefault();
                    const btn = e.target.closest('.chart-period-btn');
                    const symbol = btn.dataset.symbol;
                    const period = btn.dataset.period;
                    console.log('Price Chart button clicked for:', symbol, 'period:', period);
                    showPriceChart(symbol, period);
                }
            });
        });

        // VNINDEX Chart functionality
        async function loadVNIndexChart(period = '1M') {
            const loadingEl = document.getElementById('vnindexLoading');
            const errorEl = document.getElementById('vnindexError');
            const canvas = document.getElementById('vnindexChart');

            try {
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');

                // Fetch real VNINDEX data from our API
                const response = await fetch(`/vnindex-data?period=${period}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to fetch VNINDEX data');
                }
                
                // Update price display if elements exist
                const priceEl = document.getElementById('vnindexPrice');
                const changeEl = document.getElementById('vnindexChange');
                
                if (priceEl) {
                    priceEl.textContent = result.latest_price.toFixed(2);
                }
                
                if (changeEl) {
                    const isPositive = result.price_change >= 0;
                    changeEl.innerHTML = `
                        <span class="${isPositive ? 'text-green-600' : 'text-red-600'}">
                            <i class="fas fa-arrow-${isPositive ? 'up' : 'down'} mr-1"></i>
                            ${result.price_change.toFixed(2)} (${result.price_change_percent.toFixed(2)}%)
                        </span>
                    `;
                }

                // Destroy existing chart
                if (chartInstances['vnindex']) {
                    chartInstances['vnindex'].destroy();
                }

                // Create new chart with real data
                const ctx = canvas.getContext('2d');
                chartInstances['vnindex'] = new Chart(ctx, result.chart_config);
                
                console.log(`VNINDEX chart loaded with ${result.data_points} data points for period ${period}`);

                loadingEl.classList.add('hidden');
            } catch (error) {
                console.error('Error loading VN-Index chart:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                
                // Show detailed error message
                if (errorEl) {
                    errorEl.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle text-orange-500 mb-2"></i>
                            <p class="text-sm text-gray-600">
                                Failed to load VNINDEX data: ${error.message}
                            </p>
                        </div>
                    `;
                }
            }
        }

        // VNINDEX period button handlers
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('vnindex-period-btn')) {
                const period = e.target.dataset.period;
                
                // Update button states
                document.querySelectorAll('.vnindex-period-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                });
                
                e.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
                e.target.classList.add('bg-primary', 'text-white');
                
                // Load chart with new period
                loadVNIndexChart(period);
            }
        });


        // Load sources from database
        async function loadSourcesFromDatabase() {
            try {
                const response = await fetch("/sources", {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                sources = result.sources.map(dbSource => ({
                    url: dbSource.url,
                    sourceName: dbSource.name,
                    sourceType: "Company",
                    xpath: dbSource.xpath_title || "",
                    pagination: "",
                    contentXpath: dbSource.xpath_content || "",
                    contentDateXpath: dbSource.xpath_date || "",
                    status: dbSource.status || "active",
                    id: dbSource.id
                }));
                
                updateSourcesList();
            } catch (error) {
                console.error("Error loading sources:", error);
            }
        }

        // Load recent stocks with modern styling
        async function loadRecentStocks() {
            try {
                const days = dashboardDays.value;
                
                stocksLoading.classList.remove("hidden");
                stocksContent.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-3xl text-primary mb-4"></i>
                        <p class="text-gray-500 text-lg">Loading trending stocks...</p>
                    </div>
                `;
                
                const response = await fetch(`/recent-stocks?days=${days}`, {
                    method: "GET",
                    headers: { "Content-Type": "application/json" },
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                // If no real data is available, use test data for demonstration
                if (!result.stocks || result.stocks.length === 0) {
                    console.log("No real stock data found, loading test data for demonstration");
                    const testResponse = await fetch('/create-test-data');
                    if (testResponse.ok) {
                        const testData = await testResponse.json();
                        result.stocks = testData.stocks;
                        console.log("Test data loaded:", result.stocks);
                    }
                }
                
                displayRecentStocks(result.stocks, days);
                
            } catch (error) {
                console.error("Error loading recent stocks:", error);
                stocksContent.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
                        <p class="text-gray-500 text-lg">Unable to load stock data</p>
                        <button onclick="loadRecentStocks()" class="mt-4 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function displayRecentStocks(stocks, days) {
            if (!stocks || stocks.length === 0) {
                stocksContent.innerHTML = `
                    <div class="text-center py-16">
                        <i class="fas fa-chart-line text-6xl text-gray-300 mb-6"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No trending stocks found</h3>
                        <p class="text-gray-500 mb-6">No stocks were mentioned in the last ${days} days</p>
                        <button onclick="document.querySelector('[data-page=analyze]').click()" class="bg-primary hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors font-medium">
                            Configure Sources
                        </button>
                    </div>
                `;
                return;
            }

            const stocksHtml = stocks.map(stock => {
                const sentimentColor = getSentimentColor(stock.sentiment);
                
                const postsHtml = (stock.posts || []).map(post => `
                    <div class="bg-white border border-gray-100 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="text-xs font-medium text-primary bg-blue-50 px-2 py-1 rounded-full">${post.source_name}</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${getSentimentColor(post.sentiment)}">
                                        ${post.sentiment}
                                    </span>
                                    <span class="text-xs text-gray-500">${formatDate(post.created_date)}</span>
                                </div>
                                <a href="${post.url}" target="_blank" class="text-sm text-gray-700 hover:text-primary line-clamp-2 leading-relaxed">
                                    ${post.summary}
                                </a>
                            </div>
                            <a href="${post.url}" target="_blank" class="ml-3 text-primary hover:text-blue-600 p-1">
                                <i class="fas fa-external-link-alt text-xs"></i>
                            </a>
                        </div>
                        ${post.stock_mention_summary ? `
                            <div class="text-xs text-gray-600 bg-gray-50 rounded-lg p-3 mt-2">
                                <span class="font-medium text-dark">About ${stock.symbol}:</span> ${post.stock_mention_summary}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
                return `
                    <div class="bg-white border border-gray-100 rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center">
                                    <span class="text-white font-bold text-lg">${stock.symbol}</span>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-dark">${stock.symbol}</h3>
                                    ${stock.isvn30 ? '<span class="inline-flex items-center px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full border border-yellow-200"><i class="fas fa-star mr-1"></i>VN30</span>' : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium ${sentimentColor}">
                                        ${stock.sentiment}
                                    </span>
                                </div>
                                <p class="text-xs text-gray-500">${stock.posts_count} posts</p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 leading-relaxed">
                                <strong>${stock.name}</strong> â€¢ ${stock.exchange}
                            </p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-4">
                            <h4 class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                                <i class="fas fa-chart-line mr-2"></i>Market Sentiment
                            </h4>
                            <p class="text-sm text-blue-700 leading-relaxed">
                                ${stock.summary || 'No analysis summary available'}
                            </p>
                        </div>
                        
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-dark flex items-center">
                                    <i class="fas fa-newspaper mr-2 text-primary"></i>Recent Posts
                                </h4>
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs font-medium">
                                    ${stock.posts_count}
                                </span>
                            </div>
                            <div class="max-h-80 overflow-y-auto space-y-2">
                                ${postsHtml || '<p class="text-sm text-gray-500 italic text-center py-4">No posts available</p>'}
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-100 mt-4">
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span>Last updated: ${formatDate(stock.last_updated)}</span>
                                <div class="flex items-center space-x-4">
                                    <button class="load-company-info-btn text-primary hover:text-blue-600 font-medium" data-symbol="${stock.symbol}">
                                        <i class="fas fa-info-circle mr-1"></i>Company Info
                                    </button>
                                    <button class="chart-period-btn text-primary hover:text-blue-600 font-medium" data-period="7d" data-symbol="${stock.symbol}">
                                        <i class="fas fa-chart-area mr-1"></i>Price Chart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            stocksContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${stocksHtml}
                </div>
                <div class="text-center mt-8 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">
                        Showing <span class="font-semibold text-dark">${stocks.length}</span> trending stocks from the last <span class="font-semibold text-dark">${days}</span> days
                    </p>
                </div>
            `;

            // Store data for filtering
            currentStocksData = stocks;
        }

        // Form handling functions
        function showNewSourceForm() {
            newSourceForm.classList.remove("hidden");
            addNewPageBtn.style.display = "none";
            sourceForm.reset();
            currentEditingIndex = -1;
        }

        function hideNewSourceForm() {
            newSourceForm.classList.add("hidden");
            addNewPageBtn.style.display = "block";
            sourceForm.reset();
            currentEditingIndex = -1;
        }

        async function saveSource(e) {
            e.preventDefault();
            
            const formData = new FormData(sourceForm);
            const sourceData = {
                url: formData.get("url"),
                sourceName: formData.get("sourceName"),
                sourceType: formData.get("sourceType"),
                xpath: formData.get("xpath"),
                pagination: formData.get("paginationRule"),
                contentXpath: formData.get("contentXpath"),
                contentDateXpath: formData.get("contentDateXpath"),
            };

            try {
                const response = await fetch("/sources", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(sourceData),
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                await loadSourcesFromDatabase();
                hideNewSourceForm();
                
            } catch (error) {
                console.error("Error saving source:", error);
                showError(`Failed to save source: ${error.message}`);
            }
        }

        function updateSourcesList() {
            if (sources.length === 0) {
                emptyState.classList.remove("hidden");
                crawlSection.classList.add("hidden");
                return;
            }

            emptyState.classList.add("hidden");
            crawlSection.classList.remove("hidden");

            sourcesList.innerHTML = sources.map((source, index) => {
                const isActive = source.status === 'active';
                const statusColor = isActive ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200';
                const statusText = isActive ? 'Active' : 'Inactive';
                
                return `
                    <div class="bg-white border border-gray-100 rounded-xl p-6 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-4 mb-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-secondary rounded-lg flex items-center justify-center">
                                        <i class="fas fa-globe text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-dark text-lg">${source.sourceName}</h4>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-lg text-xs font-medium">
                                                ${source.sourceType || 'Company'}
                                            </span>
                                            <span class="px-2 py-1 ${statusColor} rounded-lg text-xs font-medium border">
                                                ${statusText}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 break-all bg-gray-50 p-2 rounded-lg">
                                    <i class="fas fa-link mr-2 text-primary"></i>${source.url}
                                </p>
                            </div>
                            <div class="flex items-center space-x-3 ml-6">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" ${isActive ? 'checked' : ''} 
                                           onchange="toggleSourceStatus(${index})"
                                           class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                                
                                <div class="flex space-x-2">
                                    <button onclick="editSource(${index})" 
                                            class="text-primary hover:text-blue-600 p-2 hover:bg-blue-50 rounded-lg transition-colors">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteSource(${index})" 
                                            class="text-red-500 hover:text-red-600 p-2 hover:bg-red-50 rounded-lg transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleSourceStatus(index) {
            const source = sources[index];
            const newStatus = source.status === 'active' ? 'inactive' : 'active';
            
            try {
                const response = await fetch(`/sources/${source.id}/status`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: newStatus }),
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                sources[index].status = newStatus;
                updateSourcesList();
                
            } catch (error) {
                console.error("Error updating source status:", error);
                updateSourcesList(); // Revert UI
                showError(`Failed to update source status: ${error.message}`);
            }
        }

        function editSource(index) {
            const source = sources[index];
            currentEditingIndex = index;
            
            sourceForm.sourceName.value = source.sourceName;
            sourceForm.sourceType.value = source.sourceType;
            sourceForm.url.value = source.url;
            sourceForm.xpath.value = source.xpath || '';
            sourceForm.paginationRule.value = source.pagination || '';
            sourceForm.contentXpath.value = source.contentXpath || '';
            sourceForm.contentDateXpath.value = source.contentDateXpath || '';
            
            showNewSourceForm();
        }

        function deleteSource(index) {
            if (confirm('Are you sure you want to delete this source?')) {
                sources.splice(index, 1);
                updateSourcesList();
            }
        }

        async function crawlAllSources() {
            const activeSources = sources.filter(source => source.status === 'active');
            
            if (activeSources.length === 0) {
                showError('No active sources found. Please add sources and make sure they are active.');
                return;
            }

            resultsContainer.classList.add("hidden");
            crawlText.innerHTML = `<i class="fas fa-spinner fa-spin mr-3"></i>Analyzing ${activeSources.length} Sources...`;
            crawlAllBtn.disabled = true;

            try {
                const selectedDays = parseInt(crawlDays.value);
                
                const response = await fetch("/crawl-multiple", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        sources: activeSources,
                        days: selectedDays
                    }),
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                displayResults(result);

            } catch (error) {
                console.error("Error during analysis:", error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                crawlText.innerHTML = '<i class="fas fa-rocket mr-3"></i>Start Analysis';
                crawlAllBtn.disabled = false;
            }
        }

        function displayResults(data) {
            // Implementation would be similar to the original displayResults function
            // but with the new styling applied
            resultsContainer.classList.remove("hidden");
            
            // For now, just show a success message
            const metadataContent = document.getElementById("metadataContent");
            if (data.metadata) {
                metadataContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${data.metadata.sources_analyzed || 0}</div>
                            <div class="text-sm text-blue-800">Sources Analyzed</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${data.metadata.total_posts_analyzed || 0}</div>
                            <div class="text-sm text-green-800">Posts Analyzed</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600">${data.metadata.unique_stocks_found || 0}</div>
                            <div class="text-sm text-purple-800">Stocks Found</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600">${data.metadata.success_rate || 'N/A'}</div>
                            <div class="text-sm text-yellow-800">Success Rate</div>
                        </div>
                    </div>
                `;
            }
        }

        // Helper functions
        function getSentimentColor(sentiment) {
            switch (sentiment?.toLowerCase()) {
                case 'positive': return 'bg-green-100 text-green-800 border-green-200';
                case 'negative': return 'bg-red-100 text-red-800 border-red-200';
                case 'neutral': return 'bg-gray-100 text-gray-800 border-gray-200';
                default: return 'bg-gray-100 text-gray-800 border-gray-200';
            }
        }

        function formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch {
                return dateString;
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorBox.classList.remove("hidden");
            setTimeout(() => {
                errorBox.classList.add("hidden");
            }, 5000);
        }

        // Filter functionality (simplified for now)
        function setupEventListeners() {
            document.getElementById('stockSearch')?.addEventListener('input', applyFilters);
            document.getElementById('sentimentFilter')?.addEventListener('change', applyFilters);
            document.getElementById('vn30Filter')?.addEventListener('change', applyFilters);
            document.getElementById('sortBy')?.addEventListener('change', applyFilters);
            document.getElementById('sortOrder')?.addEventListener('change', applyFilters);
            document.getElementById('clearFilters')?.addEventListener('click', clearFilters);
        }

        function applyFilters() {
            // Filter implementation would go here
            // For now, just reload the stocks
            if (currentStocksData.length > 0) {
                displayRecentStocks(currentStocksData, dashboardDays.value);
            }
        }

        function clearFilters() {
            document.getElementById('stockSearch').value = '';
            document.getElementById('sentimentFilter').value = '';
            document.getElementById('vn30Filter').value = '';
            document.getElementById('sortBy').value = 'posts_count';
            document.getElementById('sortOrder').value = 'desc';
            applyFilters();
        }
        
        // Company info functionality
        async function loadCompanyInfo(symbol) {
            try {
                console.log(`Loading company info for ${symbol}`);
                showToast(`Loading company information for ${symbol}...`, 'info');
                
                const response = await fetch(`/company-info/${symbol}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load company information');
                }
                
                // Display company info in a modal or popup
                showCompanyInfoModal(symbol, result.company_info);
                showToast(`Company information loaded successfully!`, 'success');
                
            } catch (error) {
                console.error('Error loading company info:', error);
                showToast(`Failed to load company info for ${symbol}: ${error.message}`, 'error');
            }
        }
        
        // Price chart functionality
        async function showPriceChart(symbol, period = '7d') {
            try {
                console.log(`Loading price chart for ${symbol} (${period})`);
                showToast(`Loading price chart for ${symbol}...`, 'info');
                
                const response = await fetch(`/stock-prices/${symbol}?period=${period}`);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to load price data');
                }
                
                // Display price chart in a modal
                showPriceChartModal(symbol, result);
                showToast(`Price chart loaded successfully!`, 'success');
                
            } catch (error) {
                console.error('Error loading price chart:', error);
                showToast(`Failed to load price chart for ${symbol}: ${error.message}`, 'error');
            }
        }
        
        // Modal functions
        function showCompanyInfoModal(symbol, companyInfo) {
            const modal = createModal(`${symbol} - Company Information`, `
                <div class="space-y-6">
                    <!-- Overview -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">Company Overview</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Name:</span>
                                <span class="ml-2 font-medium">${companyInfo.overview?.name || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Exchange:</span>
                                <span class="ml-2 font-medium">${companyInfo.overview?.exchange || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Issue Share:</span>
                                <span class="ml-2 font-medium">${companyInfo.overview?.issue_share?.toLocaleString() || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Charter Capital:</span>
                                <span class="ml-2 font-medium">${companyInfo.overview?.charter_capital?.toLocaleString() || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Events -->
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-3">Recent Events</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${companyInfo.recent_events?.map(event => `
                                <div class="bg-white p-3 rounded border text-sm">
                                    <div class="font-medium">${event.event_name || 'Event'}</div>
                                    <div class="text-gray-600">${event.event_date || 'N/A'}</div>
                                    ${event.description ? `<div class="mt-1 text-gray-700">${event.description}</div>` : ''}
                                </div>
                            `).join('') || '<div class="text-gray-500 text-center py-4">No recent events</div>'}
                        </div>
                    </div>
                    
                    <!-- Recent Dividends -->
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-3">Recent Dividends</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${companyInfo.recent_dividends?.map(dividend => `
                                <div class="bg-white p-3 rounded border text-sm">
                                    <div class="flex justify-between">
                                        <div class="font-medium">Year ${dividend.cash_year || 'N/A'}</div>
                                        <div class="text-green-600 font-semibold">${dividend.cash_dividend_percentage || 0}%</div>
                                    </div>
                                    <div class="text-gray-600">${dividend.exercise_date || 'N/A'}</div>
                                </div>
                            `).join('') || '<div class="text-gray-500 text-center py-4">No recent dividends</div>'}
                        </div>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }
        
        function showPriceChartModal(symbol, chartData) {
            const modal = createModal(`${symbol} - Price Chart (${chartData.period})`, `
                <div class="space-y-4">
                    <!-- Price Stats -->
                    <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <div class="text-sm text-gray-600">Data Points</div>
                            <div class="text-lg font-semibold">${chartData.data_points || 0}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600">Period</div>
                            <div class="text-lg font-semibold">${chartData.period}</div>
                        </div>
                    </div>
                    
                    <!-- Chart Container -->
                    <div class="relative h-80">
                        <canvas id="modalPriceChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
            
            // Create chart after modal is added to DOM
            setTimeout(() => {
                const canvas = document.getElementById('modalPriceChart');
                if (canvas && chartData.chart_config) {
                    new Chart(canvas.getContext('2d'), chartData.chart_config);
                }
            }, 100);
        }
        
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between p-6 border-b border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800">${title}</h3>
                        <button class="modal-close-btn text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        ${content}
                    </div>
                </div>
            `;
            
            // Close modal handlers
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.closest('.modal-close-btn')) {
                    modal.remove();
                }
            });
            
            // Add ESC key support
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            return modal;
        }

        // Simple toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>